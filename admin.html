<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Bianco Timer - Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Cairo", Arial, sans-serif; direction: rtl; background: #0d0d0d; color: #fff; padding: 20px; }
    .panel { background: rgba(20, 20, 20, 0.9); padding: 18px; border-radius: 10px; max-width: 1250px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-align: center; font-size: 14px; }
    th { background: rgba(255,255,255,0.1); }
    button { border: none; border-radius: 6px; cursor: pointer; padding: 6px 10px; color: #fff; }
    .editBtn { background: #ffc107; color: #000; }
    .danger { background: #dc3545; }
    .stats { display: flex; gap: 20px; flex-wrap: wrap; background: #111; padding: 10px 14px; border-radius: 8px; margin: 14px 0; justify-content: space-around; }
    .card { background: #1c1c1c; padding: 10px 14px; border-radius: 6px; min-width: 180px; text-align: center; }
    .edit-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; visibility: hidden; }
    .edit-modal.active { visibility: visible; }
    .modal-content { background: #222; padding: 20px; border-radius: 10px; width: 350px; }
    input, select { width: 100%; margin: 5px 0; padding: 8px; border-radius: 6px; border: none; }
  </style>
</head>
<body>
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>🔑 واجهة المشرف - Bianco Timer</h2>
      <div>
        <span id="userEmail"></span>
        <button id="logoutBtn" style="background:#ff9800;">تسجيل خروج</button>
      </div>
    </div>

    <div class="stats">
      <div class="card">📅 التاريخ: <br><b id="today"></b></div>
      <div class="card">📊 عدد الجلسات اليوم: <br><b id="sessionCount">0</b></div>
      <div class="card">💰 إجمالي الإيرادات اليوم: <br><b id="totalRevenue">0</b> ج</div>
    </div>

    <table id="sessionsTable">
      <thead>
        <tr>
          <th>الجهاز</th><th>النوع</th><th>من → إلى</th><th>المدة</th><th>السعر</th><th>الطلبات</th><th>أنشئ بواسطة</th><th>التاريخ</th><th>عمليات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- نافذة التعديل -->
  <div class="edit-modal" id="editModal">
    <div class="modal-content">
      <h3>✏️ تعديل الجلسة</h3>
      <label>الجهاز:</label>
      <select id="editDevice">
        <option value="ping">بنج</option>
        <option value="ps4">بلايستيشن 4</option>
        <option value="ps5">بلايستيشن 5</option>
      </select>

      <label>النوع:</label>
      <select id="editType">
        <option value="single">فردي</option>
        <option value="double">زوجي</option>
      </select>

      <label>من:</label>
      <input type="time" id="editStart">
      <label>إلى:</label>
      <input type="time" id="editEnd">

      <label>السعر:</label>
      <input type="number" id="editPrice" placeholder="السعر الكلي">

      <label>الطلبات:</label>
      <input type="text" id="editDrinks" placeholder="شاي×2, بيبسي×1">

      <div style="text-align:right;margin-top:8px;">
        <button id="saveEditBtn" style="background:#28a745;">💾 حفظ</button>
        <button id="cancelEditBtn" style="background:#666;">إلغاء</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBFI6W1mCbFsG8MfcGxWL0JonZtJ_7P6W0",
      authDomain: "bianco-playstation.firebaseapp.com",
      projectId: "bianco-playstation",
      storageBucket: "bianco-playstation.firebasestorage.app",
      messagingSenderId: "699813217029",
      appId: "1:699813217029:web:568e169371a2361358ad6c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const todayEl = document.getElementById("today");
    const tableBody = document.querySelector("#sessionsTable tbody");
    const sessionCount = document.getElementById("sessionCount");
    const totalRevenue = document.getElementById("totalRevenue");
    const userEmail = document.getElementById("userEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const editModal = document.getElementById("editModal");
    const editDevice = document.getElementById("editDevice");
    const editType = document.getElementById("editType");
    const editStart = document.getElementById("editStart");
    const editEnd = document.getElementById("editEnd");
    const editPrice = document.getElementById("editPrice");
    const editDrinks = document.getElementById("editDrinks");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    let editingId = null;

    todayEl.textContent = new Date().toLocaleDateString("ar-EG");

    const adminEmails = ["moosama@gmail.com","ahmed@gmail.com","mahmoud@gmail.com"];

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = "login.html";
      if (!adminEmails.includes(user.email)) return alert("❌ ليس لديك صلاحية مشرف");
      userEmail.textContent = user.email;
      loadSessions();
    });

    logoutBtn.onclick = () => signOut(auth).then(()=>window.location.href='login.html');

    function formatTime12h(timeStr){
      const [h,m]=timeStr.split(':').map(Number);
      const suffix=h>=12?'مساءً':'صباحًا';
      const hh=h%12||12;
      return `${hh}:${m.toString().padStart(2,'0')} ${suffix}`;
    }

    function loadSessions(){
      const q=query(collection(db,"sessions"),orderBy("createdAt","desc"));
      onSnapshot(q,snap=>{
        tableBody.innerHTML="";
        let total=0,count=0;
        const todayDate=new Date().toLocaleDateString("ar-EG");
        snap.forEach(docSnap=>{
          const s=docSnap.data();
          const id=docSnap.id;
          const drinks=Array.isArray(s.drinks)?s.drinks.map(d=>`${d.name}×${d.qty}`).join(", "):(s.drinks||"-");
          const tr=document.createElement("tr");
          tr.innerHTML=`
          <td>${s.device}</td>
          <td>${s.type==='single'?'فردي':'زوجي'}</td>
          <td>${formatTime12h(s.start)} → ${formatTime12h(s.end)}</td>
          <td>${s.duration}</td>
          <td>${s.price} ج</td>
          <td>${drinks}</td>
          <td>${s.createdBy}</td>
          <td>${s.date||"-"}</td>
          <td>
            <button class="editBtn" onclick="editSession('${id}','${encodeURIComponent(JSON.stringify(s))}')">✏️</button>
            <button class="danger" onclick="deleteSession('${id}')">🗑</button>
          </td>`;
          tableBody.appendChild(tr);
          if(s.date===todayDate){total+=s.price;count++;}
        });
        totalRevenue.textContent=total.toFixed(2);
        sessionCount.textContent=count;
      });
    }

    window.deleteSession=async(id)=>{if(confirm("هل تريد حذف الجلسة؟"))await deleteDoc(doc(db,"sessions",id));};

    window.editSession=(id,encoded)=>{
      const s=JSON.parse(decodeURIComponent(encoded));
      editingId=id;
      editDevice.value=s.device;
      editType.value=s.type;
      editStart.value=s.start;
      editEnd.value=s.end;
      editPrice.value=s.price;
      editDrinks.value=Array.isArray(s.drinks)?s.drinks.map(d=>`${d.name}×${d.qty}`).join(", "):s.drinks;
      editModal.classList.add("active");
    };

    saveEditBtn.onclick=async()=>{
      if(!editingId)return;
      const dRef=doc(db,"sessions",editingId);
      await updateDoc(dRef,{
        device:editDevice.value,
        type:editType.value,
        start:editStart.value,
        end:editEnd.value,
        price:Number(editPrice.value),
        drinks:editDrinks.value
      });
      editModal.classList.remove("active");
      alert("✅ تم حفظ التعديلات");
    };

    cancelEditBtn.onclick=()=>editModal.classList.remove("active");
  </script>
</body>
</html>
