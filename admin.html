<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Bianco Timer - Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0d0d0d; --panel:#121216; --muted:#9aa4b2; --accent:#00c853; --danger:#e53935; --glass:rgba(255,255,255,0.04);
    }
    body{font-family:"Cairo",Arial,sans-serif;background:var(--bg);color:#fff;direction:rtl;padding:14px;margin:0}
    .container{max-width:1150px;margin:0 auto}
    .panel{background:var(--panel);padding:14px;border-radius:10px;border:1px solid var(--glass)}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);border:none;color:#021018;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid var(--glass);color:var(--muted)}
    .filters{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    select, input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .stats{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;min-width:160px;text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center;font-size:13px}
    th{background:rgba(255,255,255,0.03);color:var(--muted)}
    .editBtn{background:#ffc107;color:#000;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .danger{background:var(--danger);border:none;padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .12s}
    .modal-back.active{visibility:visible;opacity:1}
    .modal{background:#0b1a20;padding:14px;border-radius:10px;width:380px;max-width:94%}
    label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
    input[type="time"]{background:transparent}
    .right{text-align:right}
    .session-updated { background: rgba(0, 200, 83, 0.1); }
    .financial-summary { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-top: 12px; }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª */
    .shift-report {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .shift-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .shift-stat-item {
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .shift-stat-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent);
      display: block;
    }

    .shift-stat-label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    @media(max-width:700px){
      .filters{flex-direction:column;align-items:stretch}
      .stats{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <header>
        <div>
          <h1>ğŸ”‘ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±Ù - Bianco Timer</h1>
          <div class="muted">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù„Ø³Ø§ØªØŒ Ø§Ù„ÙÙ„ØªØ±Ø©ØŒ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„</div>
        </div>
        <div class="controls">
          <div id="userEmail" class="muted"></div>
          <button id="goToMain" class="btn secondary">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
          <button id="logoutBtn" class="btn secondary">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </header>

      <div class="filters">
        <div style="display:flex;gap:8px;align-items:center">
          <label class="muted">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®:</label>
          <select id="dateFilter"><option value="__all__">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</option></select>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
          <button id="refreshBtn" class="btn secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button id="exportBtn" class="btn">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
        </div>
      </div>

      <div class="stats">
        <div class="card">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯<br><b id="selectedDate">Ø§Ù„ÙŠÙˆÙ…</b></div>
        <div class="card">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª<br><b id="sessionCount">0</b></div>
        <div class="card">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©<br><b id="grossRevenue">0</b> Ø¬</div>
        <div class="card">ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª<br><b id="totalExpenses">0</b> Ø¬</div>
        <div class="card" style="background: rgba(0,200,83,0.1);">ğŸ“Š ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª<br><b id="netRevenue">0</b> Ø¬</div>
      </div>

      <div style="margin-top:12px;overflow:auto">
        <table id="sessionsTable">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù† â†’ Ø¥Ù„Ù‰</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
      <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 12px;">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
        <table id="expensesTable">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª -->
    <div style="margin-top: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0;">ğŸ“‹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª</h3>
        <button id="refreshShiftsBtn" class="btn secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>
      
      <table id="shiftsTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th>
            <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
            <th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th>
            <th>Ø§Ù„ØµØ§ÙÙŠ</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø¹Ù…Ù„ÙŠØ§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠÙØª -->
  <div class="modal-back" id="shiftDetailsModal">
    <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <h3 class="right">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙŠÙØª</h3>
      
      <div id="shiftDetailsContent">
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
      </div>
      
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
        <button class="btn secondary" id="closeShiftDetails">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
  <div class="modal-back" id="editModal">
    <div class="modal">
      <h3 class="right">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
      <input type="text" id="editDevice" />

      <label>Ø§Ù„Ù†ÙˆØ¹</label>
      <select id="editType"><option value="single">ÙØ±Ø¯ÙŠ</option><option value="double">Ø²ÙˆØ¬ÙŠ</option></select>

      <label>Ø¨Ø¯Ø§ÙŠØ©</label>
      <input id="editStart" type="time" />

      <label>Ù†Ù‡Ø§ÙŠØ©</label>
      <input id="editEnd" type="time" />

      <label>Ø§Ù„Ù…Ø¯Ø©</label>
      <input id="editDuration" />

      <label>Ø§Ù„Ø³Ø¹Ø±</label>
      <input id="editPrice" type="number" />

      <label>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
      <input id="editDrinks" />

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="saveEditBtn" class="btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button id="cancelEditBtn" class="btn secondary">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBFI6W1mCbFsG8MfcGxWL0JonZtJ_7P6W0",
      authDomain: "bianco-playstation.firebaseapp.com",
      projectId: "bianco-playstation",
      storageBucket: "bianco-playstation.firebasestorage.app",
      messagingSenderId: "699813217029",
      appId: "1:699813217029:web:568e169371a2361358ad6c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Ø¹Ù†Ø§ØµØ± DOM
    const selectedDateEl = document.getElementById('selectedDate');
    const tableBody = document.querySelector('#sessionsTable tbody');
    const sessionCountEl = document.getElementById('sessionCount');
    const grossRevenueEl = document.getElementById('grossRevenue');
    const totalExpensesEl = document.getElementById('totalExpenses');
    const netRevenueEl = document.getElementById('netRevenue');
    const dateFilter = document.getElementById('dateFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const goToMain = document.getElementById('goToMain');
    const userEmail = document.getElementById('userEmail');

    const editModal = document.getElementById('editModal');
    const editDevice = document.getElementById('editDevice');
    const editType = document.getElementById('editType');
    const editStart = document.getElementById('editStart');
    const editEnd = document.getElementById('editEnd');
    const editDuration = document.getElementById('editDuration');
    const editPrice = document.getElementById('editPrice');
    const editDrinks = document.getElementById('editDrinks');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    // Ø¹Ù†Ø§ØµØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª
    const shiftsTable = document.querySelector('#shiftsTable tbody');
    const refreshShiftsBtn = document.getElementById('refreshShiftsBtn');
    const shiftDetailsModal = document.getElementById('shiftDetailsModal');
    const shiftDetailsContent = document.getElementById('shiftDetailsContent');
    const closeShiftDetails = document.getElementById('closeShiftDetails');

    const adminEmails = ["moosama@gmail.com", "ahmed@gmail.com", "mahmoud@gmail.com"];

    let allSessions = [], filteredSessions = [], editingId = null;
    let allExpenses = [], filteredExpenses = [];
    let allShiftReports = [];

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
    function parseToISO(val){
      if(!val) return null;
      if(val.includes('T')||val.endsWith('Z')) return val;
      if(/^\d{1,2}:\d{2}$/.test(val)){
        const [hh,mm]=val.split(':').map(Number);
        const now=new Date();
        const d=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,0);
        return d.toISOString();
      }
      const dt=new Date(val);
      return !isNaN(dt)?dt.toISOString():null;
    }

    function formatTime12(val){
      if(!val) return '-';
      const iso=parseToISO(val);
      if(!iso) return val;
      const d=new Date(iso);
      const h=d.getHours(),m=d.getMinutes();
      const suffix=h>=12?'Ù…Ø³Ø§Ø¡Ù‹':'ØµØ¨Ø§Ø­Ù‹Ø§';
      const hh=h%12||12;
      return `${hh}:${m.toString().padStart(2,'0')} ${suffix}`;
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ==========
    async function saveDeleteToSyncCollection(sessionId, sessionData) {
        try {
            const syncRef = collection(db, 'sessionUpdates');
            const deletePayload = {
                sessionId: sessionId,
                deviceLabel: sessionData.deviceLabel,
                originalPrice: sessionData.price,
                originalCreatedBy: sessionData.createdBy,
                originalDeviceLabel: sessionData.deviceLabel,
                originalStartISO: sessionData.startISO,
                originalEndISO: sessionData.endISO,
                originalDate: sessionData.date,
                
                updatedAt: new Date().toISOString(),
                updatedBy: auth.currentUser.email,
                date: sessionData.date,
                
                isAdminUpdate: true,
                updateType: 'session_delete',
                isDeleted: true
            };
            
            await addDoc(syncRef, deletePayload);
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø°Ù ÙÙŠ collection Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', deletePayload);
            return true;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø°Ù:', error);
            throw error;
        }
    }

    async function saveEditToSyncCollection(sessionId, updatedData, originalSession) {
    try {
        const syncRef = collection(db, 'sessionUpdates');
        
        // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø©
        const q = query(syncRef, where("sessionId", "==", sessionId));
        const querySnapshot = await getDocs(q);
        
        const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        
        let drinksData = updatedData.drinks;
        if (typeof drinksData === 'string' && drinksData.trim() !== '') {
            drinksData = drinksData.split(',').map(item => {
                const parts = item.split('Ã—');
                if (parts.length === 2) {
                    return { 
                        name: parts[0].trim(), 
                        qty: parseInt(parts[1]) || 1 
                    };
                } else {
                    return { name: item.trim(), qty: 1 };
                }
            }).filter(item => item.name && item.name !== '-');
        } else {
            drinksData = originalSession.drinks || [];
        }
        
        // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© timestamp ÙØ±ÙŠØ¯ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
        const updateTimestamp = new Date().toISOString();
        
        const updatePayload = {
            sessionId: sessionId,
            deviceLabel: updatedData.deviceLabel,
            price: Number(updatedData.price),
            drinks: drinksData,
            mode: updatedData.mode,
            duration: updatedData.duration,
            startISO: updatedData.startISO,
            endISO: updatedData.endISO,
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
            originalPrice: originalSession.price,
            originalCreatedBy: originalSession.createdBy,
            originalDeviceLabel: originalSession.deviceLabel,
            originalStartISO: originalSession.startISO,
            originalEndISO: originalSession.endISO,
            originalDate: originalSession.date,
            
            updatedAt: updateTimestamp,
            updatedBy: auth.currentUser.email,
            date: originalSession.date,
            
            isAdminUpdate: true,
            updateType: 'session_edit',
            isDeleted: false,
            
            // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            syncId: `sync_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø²Ù…Ù†ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
            processed: false
        };
        
        await addDoc(syncRef, updatePayload);
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ collection Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', updatePayload);
        return true;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
        throw error;
    }
}



    // ========== Ø¯ÙˆØ§Ù„ localStorage ==========
    function getStorage() {
        return JSON.parse(localStorage.getItem('biancoSessionsLocal') || '{}');
    }

    function setStorage(data) {
        localStorage.setItem('biancoSessionsLocal', JSON.stringify(data));
    }

    function initLocal() {
        console.log('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
    }

    function renderDevices() {
        console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©');
    }

    // ========== Ø¯ÙˆØ§Ù„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª ==========
    function setupShiftReportsListener() {
      const shiftsCol = collection(db, 'shiftReports');
      const q = query(shiftsCol, orderBy('timestamp', 'desc'));
      
      onSnapshot(q, (snapshot) => {
        allShiftReports = [];
        snapshot.forEach(doc => {
          allShiftReports.push({
            id: doc.id,
            ...doc.data()
          });
        });
        renderShiftReports();
      });
    }

    function renderShiftReports() {
      shiftsTable.innerHTML = '';
      
      if (allShiftReports.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" style="text-align: center; padding: 20px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø´ÙŠÙØªØ§Øª</td>`;
        shiftsTable.appendChild(tr);
        return;
      }
      
      allShiftReports.forEach(shift => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${shift.userName || shift.userEmail}</td>
          <td>${shift.date}</td>
          <td>${shift.completedSessions}</td>
          <td>${shift.grossRevenue?.toFixed(0) || 0} Ø¬</td>
          <td>${shift.totalExpenses?.toFixed(0) || 0} Ø¬</td>
          <td><strong>${shift.netRevenue?.toFixed(0) || 0} Ø¬</strong></td>
          <td>${new Date(shift.timestamp).toLocaleTimeString('ar-EG')}</td>
          <td>
            <button class="editBtn" data-shift-id="${shift.id}">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
          </td>
        `;
        
        shiftsTable.appendChild(tr);
      });

      // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶
      document.querySelectorAll('[data-shift-id]').forEach(btn => {
        btn.onclick = () => showShiftDetails(btn.dataset.shiftId);
      });
    }

    function showShiftDetails(shiftId) {
      const shift = allShiftReports.find(s => s.id === shiftId);
      if (!shift) return;
      
      let detailsHTML = `
        <div class="financial-summary">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong></span>
            <span>${shift.userName || shift.userEmail}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong></span>
            <span>${shift.date}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span><strong>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong></span>
            <span>${new Date(shift.timestamp).toLocaleString('ar-EG')}</span>
          </div>
        </div>
        
        <div class="financial-summary" style="margin-top: 16px;">
          <h4 style="margin-bottom: 12px; text-align: center;">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</span>
            <span>${shift.completedSessions}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©:</span>
            <span>${shift.openSessions || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
            <span>${shift.grossRevenue?.toFixed(0) || 0} Ø¬</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span>
            <span>${shift.totalExpenses?.toFixed(0) || 0} Ø¬</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
            <span>ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</span>
            <span style="color: ${shift.netRevenue >= 0 ? '#00c853' : '#ff5252'}">${shift.netRevenue?.toFixed(0) || 0} Ø¬</span>
          </div>
        </div>
      `;
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
      if (shift.notes) {
        detailsHTML += `
          <div class="financial-summary" style="margin-top: 16px;">
            <h4 style="margin-bottom: 8px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø´ÙŠÙØª</h4>
            <p style="color: var(--muted); line-height: 1.5;">${shift.notes}</p>
          </div>
        `;
      }
      
      shiftDetailsContent.innerHTML = detailsHTML;
      shiftDetailsModal.classList.add('active');
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ==========
    function setupFirebaseListeners() {
        const sessionsCol = collection(db, 'sessions');
        const q = query(sessionsCol, orderBy('createdAt', 'desc'));
        
        onSnapshot(q, snap => {
            allSessions = [];
            snap.forEach(docSnap => {
                allSessions.push({
                    id: docSnap.id, 
                    data: docSnap.data()
                });
            });
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† localStorage
            allExpenses = getExpensesFromLocalStorage();
            
            populateDates();
            applyFilter();
        });
    }

    function getExpensesFromLocalStorage() {
        try {
            const storage = JSON.parse(localStorage.getItem('biancoSessionsLocal') || '{}');
            const expenses = [];
            
            Object.keys(storage).forEach(date => {
                if (storage[date].expenses) {
                    storage[date].expenses.forEach(expense => {
                        expenses.push({
                            ...expense,
                            date: date,
                            createdBy: 'Ù…Ø­Ù„ÙŠ'
                        });
                    });
                }
            });
            
            return expenses;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', error);
            return [];
        }
    }

    function populateDates(){
        const dates = new Set();
        
        // Ø¥Ø¶Ø§ÙØ© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø§Øª
        allSessions.forEach(s => {
            const d = s.data.date || (s.data.createdAt ? new Date(s.data.createdAt).toLocaleDateString('ar-EG') : null);
            if(d) dates.add(d);
        });
        
        // Ø¥Ø¶Ø§ÙØ© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        allExpenses.forEach(expense => {
            if (expense.date) dates.add(expense.date);
        });
        
        dateFilter.innerHTML = '<option value="__all__">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</option>';
        const sortedDates = Array.from(dates).sort().reverse();
        
        sortedDates.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            dateFilter.appendChild(opt);
        });
    }

    function applyFilter(){
        const sel = dateFilter.value;
        selectedDateEl.textContent = sel === '__all__' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®' : sel;
        
        // ØªØµÙÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø§Øª
        filteredSessions = allSessions.filter(x => {
            const sessionDate = x.data.date || (x.data.createdAt ? new Date(x.data.createdAt).toLocaleDateString('ar-EG') : '');
            return sel === '__all__' || sessionDate === sel;
        });
        
        // ØªØµÙÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        filteredExpenses = allExpenses.filter(expense => {
            return sel === '__all__' || expense.date === sel;
        });
        
        renderTable();
        renderExpensesTable();
        calculateFinancialSummary();
    }

    function calculateFinancialSummary() {
        const grossRevenue = filteredSessions.reduce((sum, x) => sum + (Number(x.data.price) || 0), 0);
        const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + (Number(expense.amount) || 0), 0);
        const netRevenue = grossRevenue - totalExpenses;
        
        grossRevenueEl.textContent = grossRevenue.toFixed(2);
        totalExpensesEl.textContent = totalExpenses.toFixed(2);
        netRevenueEl.textContent = netRevenue.toFixed(2);
        sessionCountEl.textContent = filteredSessions.length;
    }

    function renderTable(){
        tableBody.innerHTML = '';
        
        if (filteredSessions.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</td>`;
            tableBody.appendChild(tr);
            return;
        }
        
        filteredSessions.forEach(item => {
            const s = item.data;
            const id = item.id;
            const tr = document.createElement('tr');
            
            if (s.updatedByAdmin) {
                tr.classList.add('session-updated');
            }
            
            const drinksText = Array.isArray(s.drinks) 
                ? s.drinks.map(d => `${d.name}Ã—${d.qty}`).join(', ')
                : (s.drinks || '-');
            
            tr.innerHTML = `
                <td>${s.deviceLabel || '-'}</td>
                <td>${(s.mode || s.type) === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ'}</td>
                <td>${formatTime12(s.startISO || s.start)} â†’ ${formatTime12(s.endISO || s.end)}</td>
                <td>${s.duration || '-'}</td>
                <td>${s.price || 0} Ø¬</td>
                <td>${drinksText}</td>
                <td>${s.createdBy || '-'}</td>
                <td>${s.date || '-'}</td>
                <td>
                    <button class="editBtn" data-id="${id}">âœï¸</button>
                    <button class="danger" data-id="${id}">ğŸ—‘</button>
                </td>`;
            tableBody.appendChild(tr);
        });

        // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('.editBtn').forEach(btn => {
            btn.onclick = () => editSession(btn.dataset.id);
        });
        
        document.querySelectorAll('.danger').forEach(btn => {
            btn.onclick = () => deleteSession(btn.dataset.id);
        });
    }

    function renderExpensesTable() {
        const expensesTbody = document.querySelector('#expensesTable tbody');
        expensesTbody.innerHTML = '';
        
        if (filteredExpenses.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" style="text-align: center; padding: 20px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</td>`;
            expensesTbody.appendChild(tr);
            return;
        }
        
        filteredExpenses.forEach((expense, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${expense.name}</td>
                <td>${expense.amount} Ø¬</td>
                <td>${expense.date}</td>
                <td>${expense.createdBy || 'Ù…Ø­Ù„ÙŠ'}</td>
            `;
            expensesTbody.appendChild(tr);
        });
    }

    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ==========
    async function editSession(id){
        const session = allSessions.find(x => x.id === id);
        if(!session) return;
        
        const s = session.data;
        editingId = id;
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        editDevice.value = s.deviceLabel || '';
        editType.value = s.mode || s.type || 'single';
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ 24 Ø³Ø§Ø¹Ø©
        const startTime = s.startISO ? new Date(s.startISO).toTimeString().slice(0,5) : '';
        const endTime = s.endISO ? new Date(s.endISO).toTimeString().slice(0,5) : '';
        
        editStart.value = startTime;
        editEnd.value = endTime;
        editDuration.value = s.duration || '';
        editPrice.value = s.price || 0;
        
        const drinksText = Array.isArray(s.drinks) 
            ? s.drinks.map(d => `${d.name}Ã—${d.qty}`).join(', ')
            : (s.drinks || '');
            
        editDrinks.value = drinksText;
        editModal.classList.add('active');
    }

    async function deleteSession(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ')) return;
        
        try {
            const session = allSessions.find(x => x.id === id);
            if (!session) return;
            
            await saveDeleteToSyncCollection(id, session.data);
            await deleteDoc(doc(db, 'sessions', id));
            
            alert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©');
            
        } catch (error) {
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©: ' + error.message);
        }
    }

    // ========== Event Listeners ==========
    saveEditBtn.onclick = async () => {
        if (!editingId) return;
        
        const session = allSessions.find(x => x.id === editingId);
        if (!session) return;
        
        const originalSession = session.data;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©
        const updatedData = {
            deviceLabel: editDevice.value,
            mode: editType.value,
            startISO: parseToISO(editStart.value) || originalSession.startISO,
            endISO: parseToISO(editEnd.value) || originalSession.endISO,
            duration: editDuration.value,
            price: Number(editPrice.value),
            drinks: editDrinks.value,
            deviceId: originalSession.deviceId,
            createdBy: originalSession.createdBy,
            date: originalSession.date,
            updatedByAdmin: true,
            lastUpdate: new Date().toISOString()
        };

        try {
            const ref = doc(db, 'sessions', editingId);
            await updateDoc(ref, updatedData);
            await saveEditToSyncCollection(editingId, updatedData, originalSession);
            
            editModal.classList.remove('active');
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙÙˆØ±Ø§Ù‹');
            
        } catch (error) {
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ' + error.message);
        }
    };

    cancelEditBtn.onclick = () => {
        editModal.classList.remove('active');
        editingId = null;
    };

    dateFilter.onchange = applyFilter;
    
    refreshBtn.onclick = () => { 
        allExpenses = getExpensesFromLocalStorage();
        applyFilter(); 
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); 
    };

    refreshShiftsBtn.onclick = () => {
        renderShiftReports();
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª');
    };

    closeShiftDetails.onclick = () => {
        shiftDetailsModal.classList.remove('active');
    };

    exportBtn.onclick = () => {
        if(filteredSessions.length === 0 && filteredExpenses.length === 0) {
            return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
        }
        
        const rows = [['Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ - Bianco Timer']];
        rows.push(['Ø§Ù„ØªØ§Ø±ÙŠØ®', dateFilter.value === '__all__' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®' : dateFilter.value]);
        rows.push(['ÙˆÙ‚Øª Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleString('ar-EG')]);
        rows.push([]);
        
        // Ø§Ù„Ø¬Ù„Ø³Ø§Øª
        rows.push(['Ø§Ù„Ø¬Ù„Ø³Ø§Øª']);
        rows.push(['Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø§Ù„Ù†ÙˆØ¹', 'Ù…Ù†', 'Ø¥Ù„Ù‰', 'Ø§Ù„Ù…Ø¯Ø©', 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®']);
        
        let totalRevenue = 0;
        filteredSessions.forEach(item => {
            const s = item.data;
            const revenue = Number(s.price) || 0;
            totalRevenue += revenue;
            
            const drinksText = Array.isArray(s.drinks) 
                ? s.drinks.map(d => `${d.name}Ã—${d.qty}`).join(' | ') 
                : (s.drinks || '');
            
            rows.push([
                s.deviceLabel || '-',
                (s.mode || s.type) === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ',
                formatTime12(s.startISO || s.start),
                formatTime12(s.endISO || s.end),
                s.duration || '',
                drinksText,
                revenue,
                s.createdBy || '-',
                s.date || ''
            ]);
        });
        
        rows.push(['', '', '', '', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', totalRevenue.toFixed(2), '']);
        rows.push([]);
        
        // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        rows.push(['Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª']);
        rows.push(['Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©']);
        
        let totalExpenses = 0;
        filteredExpenses.forEach(expense => {
            const amount = Number(expense.amount) || 0;
            totalExpenses += amount;
            
            rows.push([
                expense.name,
                amount,
                expense.date,
                expense.createdBy || 'Ù…Ø­Ù„ÙŠ'
            ]);
        });
        
        rows.push(['Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', totalExpenses.toFixed(2), '', '']);
        rows.push([]);
        
        // Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ
        rows.push(['Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ']);
        rows.push(['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©', totalRevenue.toFixed(2)]);
        rows.push(['Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', totalExpenses.toFixed(2)]);
        rows.push(['ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', (totalRevenue - totalExpenses).toFixed(2)]);
        
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        const bom = "\uFEFF";
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const dateStr = dateFilter.value === '__all__' ? 'all_dates' : dateFilter.value.replace(/\//g, '-');
        a.download = `financial_report_${dateStr}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
    };

    goToMain.onclick = () => window.location.href = 'index.html';
    
    logoutBtn.onclick = () => {
        signOut(auth).then(() => {
            window.location.href = 'login.html';
        });
    };

    // ========== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ==========
    document.querySelectorAll('.modal-back').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });

    shiftDetailsModal.addEventListener('click', (e) => {
        if (e.target === shiftDetailsModal) {
            shiftDetailsModal.classList.remove('active');
        }
    });

    // ========== Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© ==========
    onAuthStateChanged(auth, user => {
        if(!user){
            window.location.href = 'login.html';
            return;
        }
        
        userEmail.textContent = user.email;
        
        if(!adminEmails.includes(user.email)){
            alert('âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø´Ø±Ù');
            window.location.href = 'index.html';
            return;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±ÙØŒ Ù†Ø¨Ø¯Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setupFirebaseListeners();
        setupShiftReportsListener();
    });

    // ========== Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ==========
    function cleanDuplicateSessions() {
        const s = getStorage();
        let totalRemoved = 0;
        
        Object.keys(s).forEach(date => {
            if (s[date].completed) {
                const uniqueSessions = [];
                const sessionKeys = new Set();
                
                s[date].completed.forEach(session => {
                    const sessionKey = session.id || 
                        `${session.deviceLabel}_${session.startISO}_${session.endISO}_${session.price}_${session.mode}`;
                    
                    if (!sessionKeys.has(sessionKey)) {
                        sessionKeys.add(sessionKey);
                        uniqueSessions.push(session);
                    } else {
                        totalRemoved++;
                        console.log('ğŸ§¹ Ø­Ø°Ù Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©:', session.deviceLabel);
                    }
                });
                
                s[date].completed = uniqueSessions;
            }
        });
        
        setStorage(s);
        
        if (totalRemoved > 0) {
            alert(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${totalRemoved} Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©`);
            initLocal();
            renderDevices();
        } else {
            alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…ÙƒØ±Ø±Ø©');
        }
    }

    // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© globally Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† console
    window.cleanDuplicateSessions = cleanDuplicateSessions;
  </script>
</body>
</html>
