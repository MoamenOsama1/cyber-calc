<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª - Bianco Timer</title>
  <style>
    :root {
      --bg1: #050f18;
      --bg2: #0b1b2b;
      --card: #093f76;
      --accent: #00c853;
      --accent-2: #03a9f4;
      --muted: #a7b5c4;
      --danger: #ff5252;
      --glass: rgba(255, 255, 255, 0.04);
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
  
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }
  
    body {
      margin: 0;
      padding: 12px;
      font-family: "Cairo", "Segoe UI", sans-serif;
      color: #eaf2fb;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      direction: rtl;
      min-height: 100vh;
    }
  
    .container { 
      max-width: 1200px; 
      margin: auto; 
      width: 100%;
    }
  
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 20px;
    }
  
    h1 { 
      margin: 0; 
      font-size: clamp(18px, 5vw, 22px); 
      line-height: 1.3;
    }
    
    .small { 
      color: var(--muted); 
      font-size: clamp(12px, 3vw, 13px);
      line-height: 1.4;
    }
  
    .btn {
      background: var(--accent);
      border: none;
      color: #021018;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: 0.2s;
      font-size: 14px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover { 
      transform: scale(1.05); 
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--glass);
      color: var(--muted);
    }
    
    .btn.secondary:hover { 
      color: #fff; 
      border-color: #888; 
    }

    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
      background: var(--card);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid var(--glass);
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label {
      color: var(--muted);
      font-size: 14px;
    }

    input, select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0f1b26;
      color: white;
      min-width: 150px;
    }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid var(--glass);
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: var(--card);
      border-radius: 10px;
      overflow: hidden;
    }
  
    th, td {
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 13px;
    }
  
    th { 
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-weight: 600;
    }

    .session-details {
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .session-table {
      font-size: 12px;
      margin-top: 10px;
    }

    .session-table th,
    .session-table td {
      padding: 6px 4px;
    }

    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        justify-content: space-between;
      }
      
      table {
        font-size: 11px;
      }
      
      th, td {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“‹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª - Bianco Timer</h1>
        <div class="small">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª ÙˆØ§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button class="btn secondary" id="goToMain">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn" id="exportAllBtn">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„</button>
      </div>
    </header>

    <!-- Ø§Ù„ÙÙ„ØªØ±Ø© -->
    <div class="filters">
      <div class="filter-group">
        <label for="dateFilter">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFilter">
      </div>
      
      <div class="filter-group">
        <label for="viewType">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶:</label>
        <select id="viewType">
          <option value="shifts">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª</option>
          <option value="sessions">Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙ‚Ø·</option>
          <option value="all">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
        </select>
      </div>

      <button class="btn" id="applyFilter">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
      <button class="btn secondary" id="clearFilter">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±</button>
    </div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-number" id="totalShifts">0</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ÙŠÙØªØ§Øª</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalSessions">0</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalRevenue">0 Ø¬</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalExpenses">0 Ø¬</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="netRevenue">0 Ø¬</div>
        <div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
      </div>
    </div>

    <!-- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª -->
    <div id="shiftsSection">
      <h3>ğŸ“‹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª</h3>
      <div id="shiftsList"></div>
    </div>

    <!-- Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø© -->
    <div id="sessionsSection" style="margin-top: 30px;">
      <h3>ğŸ® Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø©</h3>
      <table id="sessionsTable">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ù…Ù†</th>
            <th>Ø¥Ù„Ù‰</th>
            <th>Ø§Ù„Ù…Ø¯Ø©</th>
            <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
          </tr>
        </thead>
        <tbody id="sessionsList"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBFI6W1mCbFsG8MfcGxWL0JonZtJ_7P6W0",
      authDomain: "bianco-playstation.firebaseapp.com",
      projectId: "bianco-playstation",
      storageBucket: "bianco-playstation.firebasestorage.app",
      messagingSenderId: "699813217029",
      appId: "1:699813217029:web:568e169371a2361358ad6c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const goToMain = document.getElementById('goToMain');
    const exportAllBtn = document.getElementById('exportAllBtn');
    const dateFilter = document.getElementById('dateFilter');
    const viewType = document.getElementById('viewType');
    const applyFilter = document.getElementById('applyFilter');
    const clearFilter = document.getElementById('clearFilter');
    const shiftsList = document.getElementById('shiftsList');
    const sessionsList = document.getElementById('sessionsList');
    const totalShifts = document.getElementById('totalShifts');
    const totalSessions = document.getElementById('totalSessions');
    const totalRevenue = document.getElementById('totalRevenue');
    const totalExpenses = document.getElementById('totalExpenses');
    const netRevenue = document.getElementById('netRevenue');

    let allShiftReports = [];
    let allSessions = [];
    let filteredData = [];

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    function init() {
      loadShiftReports();
      loadAllSessions();
      
      // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
      const today = new Date().toISOString().split('T')[0];
      dateFilter.value = today;
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª
    async function loadShiftReports() {
      try {
        const shiftsQuery = query(collection(db, 'shiftReports'), orderBy('timestamp', 'desc'));
        const snapshot = await getDocs(shiftsQuery);
        
        allShiftReports = [];
        snapshot.forEach(doc => {
          allShiftReports.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        applyFilters();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª:', error);
        allShiftReports = [];
        applyFilters();
      }
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    async function loadAllSessions() {
      try {
        const sessionsQuery = query(collection(db, 'sessions'), orderBy('createdAt', 'desc'));
        const snapshot = await getDocs(sessionsQuery);
        
        allSessions = [];
        snapshot.forEach(doc => {
          allSessions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        applyFilters();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø§Øª:', error);
        allSessions = [];
        applyFilters();
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
    function applyFilters() {
      const selectedDate = dateFilter.value;
      const selectedView = viewType.value;
      
      let filteredShifts = [...allShiftReports];
      let filteredSessions = [...allSessions];
      
      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
      if (selectedDate) {
        filteredShifts = filteredShifts.filter(shift => 
          shift.date === selectedDate || shift.timestamp?.includes(selectedDate)
        );
        
        filteredSessions = filteredSessions.filter(session => 
          session.date === selectedDate || session.createdAt?.includes(selectedDate)
        );
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      updateStatistics(filteredShifts, filteredSessions);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      if (selectedView === 'shifts') {
        renderShiftReports(filteredShifts);
        document.getElementById('sessionsSection').style.display = 'none';
        document.getElementById('shiftsSection').style.display = 'block';
      } else if (selectedView === 'sessions') {
        renderSessions(filteredSessions);
        document.getElementById('shiftsSection').style.display = 'none';
        document.getElementById('sessionsSection').style.display = 'block';
      } else {
        renderShiftReports(filteredShifts);
        renderSessions(filteredSessions);
        document.getElementById('shiftsSection').style.display = 'block';
        document.getElementById('sessionsSection').style.display = 'block';
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function updateStatistics(shifts, sessions) {
      // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´ÙŠÙØªØ§Øª
      const totalShiftsCount = shifts.length;
      const shiftsRevenue = shifts.reduce((sum, shift) => sum + (shift.grossRevenue || 0), 0);
      const shiftsExpenses = shifts.reduce((sum, shift) => sum + (shift.totalExpenses || 0), 0);
      const shiftsNet = shiftsRevenue - shiftsExpenses;
      
      // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø³Ø§Øª
      const totalSessionsCount = sessions.length;
      const sessionsRevenue = sessions.reduce((sum, session) => sum + (Number(session.price) || 0), 0);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      totalShifts.textContent = totalShiftsCount;
      totalSessions.textContent = totalSessionsCount;
      totalRevenue.textContent = Math.round(shiftsRevenue + sessionsRevenue) + ' Ø¬';
      totalExpenses.textContent = Math.round(shiftsExpenses) + ' Ø¬';
      netRevenue.textContent = Math.round(shiftsNet + sessionsRevenue) + ' Ø¬';
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª
    function renderShiftReports(shifts) {
      if (shifts.length === 0) {
        shiftsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø´ÙŠÙØªØ§Øª</div>';
        return;
      }
      
      let html = '';
      shifts.forEach(shift => {
        html += `
          <div class="session-details">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <strong>${shift.userName || shift.userEmail}</strong>
                <div class="small">${shift.date} - ${new Date(shift.timestamp).toLocaleTimeString('ar-EG')}</div>
              </div>
              <div style="text-align: left;">
                <strong style="color: var(--accent);">${shift.netRevenue?.toFixed(0) || 0} Ø¬</strong>
                <div class="small">ØµØ§ÙÙŠ</div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 10px;">
              <div>
                <div class="small">Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>
                <div>${shift.completedSessions || 0}</div>
              </div>
              <div>
                <div class="small">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                <div>${shift.grossRevenue?.toFixed(0) || 0} Ø¬</div>
              </div>
              <div>
                <div class="small">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                <div>${shift.totalExpenses?.toFixed(0) || 0} Ø¬</div>
              </div>
              <div>
                <div class="small">Ù…ÙØªÙˆØ­Ø©</div>
                <div>${shift.openSessions || 0}</div>
              </div>
            </div>
            
            ${shift.notes ? `
              <div style="margin-top: 8px;">
                <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                <div style="color: var(--muted); font-size: 12px;">${shift.notes}</div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      shiftsList.innerHTML = html;
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    function renderSessions(sessions) {
      if (sessions.length === 0) {
        sessionsList.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</td></tr>';
        return;
      }
      
      let html = '';
      sessions.forEach(session => {
        const drinksTxt = Array.isArray(session.drinks) 
          ? session.drinks.map(d => `${d.name}Ã—${d.qty}`).join(', ')
          : (session.drinks || '-');
        
        const startTime = session.startISO ? new Date(session.startISO).toLocaleTimeString('ar-EG') : '-';
        const endTime = session.endISO ? new Date(session.endISO).toLocaleTimeString('ar-EG') : '-';
        
        html += `
          <tr>
            <td>${session.date || '-'}</td>
            <td>${session.deviceLabel || '-'}</td>
            <td>${session.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ'}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${session.duration || '-'}</td>
            <td>${drinksTxt}</td>
            <td>${session.price || 0} Ø¬</td>
            <td>${session.createdBy || '-'}</td>
          </tr>
        `;
      });
      
      sessionsList.innerHTML = html;
    }

    // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function exportAllData() {
      const selectedDate = dateFilter.value;
      const rows = [
        ['ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ - Bianco Timer'],
        ['Ø§Ù„ØªØ§Ø±ÙŠØ®', selectedDate || 'ÙƒÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®'],
        ['ÙˆÙ‚Øª Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleString('ar-EG')],
        [''],
        ['ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª'],
        ['Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¬Ù„Ø³Ø§Øª', 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', 'Ø§Ù„ØµØ§ÙÙŠ', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª']
      ];
      
      // Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª
      allShiftReports.forEach(shift => {
        if (!selectedDate || shift.date === selectedDate || shift.timestamp?.includes(selectedDate)) {
          rows.push([
            shift.userName || shift.userEmail,
            shift.date,
            shift.completedSessions || 0,
            shift.grossRevenue || 0,
            shift.totalExpenses || 0,
            shift.netRevenue || 0,
            shift.notes || ''
          ]);
        }
      });
      
      rows.push(['']);
      rows.push(['Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø©']);
      rows.push(['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø§Ù„Ù†ÙˆØ¹', 'Ù…Ù†', 'Ø¥Ù„Ù‰', 'Ø§Ù„Ù…Ø¯Ø©', 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©']);
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù„Ø³Ø§Øª
      allSessions.forEach(session => {
        if (!selectedDate || session.date === selectedDate || session.createdAt?.includes(selectedDate)) {
          const drinksTxt = Array.isArray(session.drinks) 
            ? session.drinks.map(d => `${d.name}Ã—${d.qty}`).join(' | ')
            : (session.drinks || '-');
          
          const startTime = session.startISO ? new Date(session.startISO).toLocaleTimeString('ar-EG') : '-';
          const endTime = session.endISO ? new Date(session.endISO).toLocaleTimeString('ar-EG') : '-';
          
          rows.push([
            session.date || '-',
            session.deviceLabel || '-',
            session.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ',
            startTime,
            endTime,
            session.duration || '-',
            drinksTxt,
            session.price || 0,
            session.createdBy || '-'
          ]);
        }
      });
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù
      const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
      const bom = "\uFEFF";
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `full_report_${selectedDate || 'all'}_${new Date().getTime()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Event Listeners
    goToMain.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    exportAllBtn.addEventListener('click', exportAllData);
    applyFilter.addEventListener('click', applyFilters);
    clearFilter.addEventListener('click', () => {
      dateFilter.value = '';
      viewType.value = 'shifts';
      applyFilters();
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, user => {
      if (user) {
        init();
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
