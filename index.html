import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFI6W1mCbFsG8MfcGxWL0JonZtJ_7P6W0",
  authDomain: "bianco-playstation.firebaseapp.com",
  projectId: "bianco-playstation",
  storageBucket: "bianco-playstation.firebasestorage.app",
  messagingSenderId: "699813217029",
  appId: "1:699813217029:web:568e169371a2361358ad6c",
  measurementId: "G-YE9S5421FR"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userEmailSpan = document.getElementById('userEmail');
const logoutBtn = document.getElementById('logoutBtn');
const goAdminBtn = document.getElementById('goAdminBtn');
const deviceEl = document.getElementById('device');
const typeEl = document.getElementById('type');
const startEl = document.getElementById('start');
const endEl = document.getElementById('end');
const drinksSelect = document.getElementById('drinksSelect');
const customDrinkDiv = document.getElementById('customDrink');
const customName = document.getElementById('customName');
const customPrice = document.getElementById('customPrice');
const addBtn = document.getElementById('addBtn');
const localTbody = document.querySelector('#localTable tbody');
const msg = document.getElementById('msg');

const prices = {
  ping: { single: 30, double: 40 },
  ps4: { single: 30, double: 40 },
  ps5: { single: 40, double: 50 },
  drinks: {
    "بيبسي": 25,
    "شاي": 10,
    "قهوة": 15,
    "اندومي كبير": 25,
    "اندومي صغير": 15
  }
};

let currentUser = null;

// حفظ الجلسات في localStorage
function saveToLocalStorage(session) {
  let sessions = JSON.parse(localStorage.getItem('localSessions') || '[]');
  sessions.unshift(session);
  localStorage.setItem('localSessions', JSON.stringify(sessions));
}

// جلب الجلسات من localStorage
function getFromLocalStorage() {
  return JSON.parse(localStorage.getItem('localSessions') || '[]');
}

// عرض الجلسات من localStorage
function displayLocalSessions() {
  const sessions = getFromLocalStorage();
  localTbody.innerHTML = '';
  
  sessions.forEach(session => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${session.device}</td>
                    <td>${session.type === 'single' ? 'فردي':'زوجي'}</td>
                    <td>${session.start} → ${session.end}</td>
                    <td>${session.duration}</td>
                    <td>${session.price.toFixed(2)} ج</td>
                    <td>${session.drinks || '-'}</td>`;
    localTbody.appendChild(tr);
  });
}

onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }
  currentUser = user;
  userEmailSpan.textContent = user.email;
  
  // عرض الجلسات المحفوظة
  displayLocalSessions();
});

logoutBtn.onclick = () => signOut(auth).then(() => window.location.href='login.html');
goAdminBtn.onclick = () => window.location.href = 'admin.html';

drinksSelect.onchange = () => {
  const selected = Array.from(drinksSelect.selectedOptions).map(o => o.value);
  customDrinkDiv.style.display = selected.includes("متنوع") ? "block" : "none";
};

function compute(start, end, device, type) {
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  let s = new Date(0,0,0, sh, sm);
  let e = new Date(0,0,0, eh, em);
  if (e <= s) e.setDate(e.getDate() + 1);
  const diffMs = e - s;
  const diffMins = Math.floor(diffMs / 60000);
  const h = Math.floor(diffMins / 60);
  const m = diffMins % 60;
  const priceHour = prices[device][type];
  const total = (diffMins / 60) * priceHour;
  return { hours: h, minutes: m, total };
}

function appendLocalRow(obj) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${obj.device}</td>
                  <td>${obj.type === 'single' ? 'فردي':'زوجي'}</td>
                  <td>${obj.start} → ${obj.end}</td>
                  <td>${obj.duration}</td>
                  <td>${obj.price.toFixed(2)} ج</td>
                  <td>${obj.drinks || '-'}</td>`;
  localTbody.prepend(tr);
  
  // حفظ في localStorage
  saveToLocalStorage(obj);
}

addBtn.onclick = async () => {
  if (!startEl.value || !endEl.value) { msg.textContent='أدخل وقت البداية والنهاية'; return; }

  const device = deviceEl.value;
  const type = typeEl.value;
  const start = startEl.value;
  const end = endEl.value;

  const selectedDrinks = Array.from(drinksSelect.selectedOptions).map(o => o.value);
  let drinksTotal = 0;
  let drinksList = [];

  selectedDrinks.forEach(drink => {
    if (drink === "متنوع" && customName.value && customPrice.value) {
      drinksList.push(`${customName.value} (${customPrice.value}ج)`);
      drinksTotal += Number(customPrice.value);
    } else if (prices.drinks[drink]) {
      drinksList.push(`${drink} (${prices.drinks[drink]}ج)`);
      drinksTotal += prices.drinks[drink];
    }
  });

  const { hours, minutes, total } = compute(start, end, device, type);
  const duration = `${hours} س ${minutes} د`;
  const totalPrice = total + drinksTotal;

  const obj = { device, type, start, end, duration, price: Number(totalPrice.toFixed(2)), drinks: drinksList.join(", ") };

  appendLocalRow(obj);

  try {
    await addDoc(collection(db, 'sessions'), {
      ...obj,
      createdBy: currentUser.email,
      createdAt: new Date().toISOString()
    });
    msg.textContent = '✅ تم إضافة الجلسة وحساب المشروبات بنجاح.';
  } catch (e) {
    msg.textContent = '❌ خطأ أثناء الحفظ: ' + e.message;
  }

  startEl.value=''; endEl.value='';
  drinksSelect.value='';
  customName.value=''; customPrice.value='';
  customDrinkDiv.style.display='none';
};
