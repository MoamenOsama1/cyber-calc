<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bianco Timer - إدارة الأجهزة</title>
  <style>
    :root {
      --bg1: #050f18;
      --bg2: #0b1b2b;
      --card: #093f76;
      --accent: #00c853;
      --accent-2: #03a9f4;
      --muted: #a7b5c4;
      --danger: #ff5252;
      --glass: rgba(255, 255, 255, 0.04);
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      padding: 12px;
      font-family: "Cairo", "Segoe UI", sans-serif;
      color: #eaf2fb;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      direction: rtl;
      background: url('https://e0.pxfuel.com/wallpapers/239/293/desktop-wallpaper-playstation-background-playstation-blue-ps4.jpg') center/cover fixed, linear-gradient(135deg, var(--bg1), var(--bg2));
      backdrop-filter: blur(4px);
      min-height: 100vh;
    }

    .wrap { max-width: 1100px; margin: auto; width: 100%; }

    header {
      display: flex; justify-content: space-between; align-items: center;
      gap: 8px; flex-wrap: wrap; padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    h1 { margin: 0; font-size: clamp(18px, 5vw, 22px); line-height: 1.3; }
    .small { color: var(--muted); font-size: clamp(12px, 3vw, 13px); line-height: 1.4; }

    .btn {
      background: var(--accent); border: none; color: #021018;
      padding: 10px 14px; border-radius: 10px; font-weight: 700;
      cursor: pointer; box-shadow: var(--shadow); transition: 0.2s;
      font-size: 14px; min-height: 44px; display: flex; align-items: center; justify-content: center;
    }

    .btn:hover, .btn:focus { transform: scale(1.05); outline: none; }

    .secondary {
      background: transparent; border: 1px solid var(--glass); color: var(--muted);
      padding: 9px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s;
      font-size: 14px; min-height: 44px; display: flex; align-items: center; justify-content: center;
    }

    .secondary:hover, .secondary:focus { color: #fff; border-color: #888; outline: none; }

    .summary { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; justify-content: center; }

    .card {
      background: var(--card); padding: 12px; border-radius: 10px; border: 1px solid var(--glass);
      box-shadow: var(--shadow); transition: 0.2s; flex: 1; min-width: 120px; max-width: 180px;
    }

    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px; margin-top: 16px;
    }

    .device {
      background: var(--card); border: 1px solid var(--glass); border-radius: 12px;
      padding: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 8px;
      transition: 0.3s ease; min-height: 160px;
    }

    .device:hover { transform: translateY(-3px); }

    .dev-name { font-weight: 800; color: #fff; font-size: 16px; }
    .dev-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .status { padding: 6px 8px; border-radius: 8px; font-weight: 700; font-size: 12px; white-space: nowrap; }
    .open { background: #064f2b; color: #a8f7c1; }
    .idle { background: #09131eae; color: var(--muted); border: 1px solid rgba(255,255,255,0.05); }

    .controls { display: flex; gap: 6px; margin-top: auto; }
    .controls button { flex: 1; padding: 10px 8px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; font-size: 13px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
    .start { background: var(--accent); color: #000; }
    .add { background: var(--accent-2); color: #fff; }
    .end { background: var(--danger); color: #fff; }

    .sessions { margin-top: 20px; background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid var(--glass); box-shadow: var(--shadow); overflow-x: auto; }
    .sessions-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .sessions-header strong { font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; min-width: 600px; }
    th, td { padding: 10px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
    th { color: var(--muted); }

    footer { margin-top: 16px; text-align: center; color: var(--muted); font-size: 12px; padding: 0 8px; line-height: 1.5; }
  </style>
</head>
<body>

  <div class="wrap">
    <header>
      <div>
        <h1>🎮 Bianco Timer - إدارة الأجهزة</h1>
        <div class="small">بنج + PS4 (1–6) + PS5 (7–15)</div>
      </div>
      <div class="header-buttons">
        <div id="userEmail" class="small"></div>
        <button class="btn" id="goAdmin">صفحة المشرف</button>
        <button class="secondary" id="logoutBtn">تسجيل الخروج</button>
      </div>
    </header>

    <section class="summary">
      <div class="card small"><div class="small">📅 التاريخ</div><div id="todayStr" style="font-weight:800;margin-top:6px"></div></div>
      <div class="card small"><div class="small">الجلسات المفتوحة</div><div id="openCount" style="font-weight:800;margin-top:6px">0</div></div>
      <div class="card small"><div class="small">إجمالي اليوم (تقديري)</div><div id="todayRevenue" style="font-weight:800;margin-top:6px">0 ج</div></div>
    </section>

    <section class="grid" id="devicesGrid"></section>

    <section class="sessions">
      <div class="sessions-header">
        <strong>جلسات اليوم</strong>
        <div class="small">🔄 يتم التحديث تلقائيًا من السحابة</div>
      </div>
      <table id="completedTable">
        <thead><tr><th>جهاز</th><th>من</th><th>إلى</th><th>المدة</th><th>الطلبات</th><th>السعر</th><th>أنشئ بواسطة</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <footer>💾 الجلسات المفتوحة محلية، والمكتملة من السحابة (Firestore).</footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBFI6W1mCbFsG8MfcGxWL0JonZtJ_7P6W0",
      authDomain: "bianco-playstation.firebaseapp.com",
      projectId: "bianco-playstation",
      storageBucket: "bianco-playstation.firebasestorage.app",
      messagingSenderId: "699813217029",
      appId: "1:699813217029:web:568e169371a2361358ad6c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const RATES = { ping:{single:30,double:40}, ps4:{single:30,double:40}, ps5:{single:40,double:50} };
    const DEVICES = []; 
    DEVICES.push({id:'ping',label:'Ping',type:'ping'}); 
    for(let i=1;i<=6;i++) DEVICES.push({id:`ps${i}`,label:`PS4-${i}`,type:'ps4'});
    for(let i=7;i<=15;i++) DEVICES.push({id:`ps${i}`,label:`PS5-${i}`,type:'ps5'});

    // Local storage للجلسات المفتوحة فقط
    const STORAGE_KEY='biancoSessionsLocal', RESET_KEY='biancoResetTime';
    function getStorage(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}catch(e){return{}} }
    function setStorage(o){ localStorage.setItem(STORAGE_KEY,JSON.stringify(o)) }
    function todayKey(){ return new Date().toLocaleDateString('ar-EG') }
    function checkReset(){ const last=localStorage.getItem(RESET_KEY), now=Date.now(); if(!last){ localStorage.setItem(RESET_KEY, now); return } const diff=(now-Number(last))/(1000*60*60); if(diff>=24){ localStorage.removeItem(STORAGE_KEY); localStorage.setItem(RESET_KEY, now); } }

    let openSessions = {};

    function initLocal(){ checkReset(); const s=getStorage(); const t=todayKey(); if(!s[t]) s[t]={open:{}}; setStorage(s); openSessions = s[t].open||{}; }
    function persistLocal(){ const s=getStorage(); s[todayKey()] = { open: openSessions }; setStorage(s); }

    // DOM
    const devicesGrid = document.getElementById('devicesGrid');
    const todayStr = document.getElementById('todayStr');
    const openCountEl = document.getElementById('openCount');
    const todayRevenueEl = document.getElementById('todayRevenue');
    const completedTbody = document.querySelector('#completedTable tbody');
    const userEmailSpan = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const goAdminBtn = document.getElementById('goAdmin');

    function nowISO(){ return new Date().toISOString(); }
    function diffMinutes(startISO,endISO){ return Math.max(0, Math.floor((new Date(endISO)-new Date(startISO))/60000)); }
    function format12FromISO(iso){ const d=new Date(iso); if(isNaN(d)) return '-'; let h=d.getHours(), m=d.getMinutes(), suf=h>=12?'مساءً':'صباحًا', hh=h%12||12; return `${hh}:${m.toString().padStart(2,'0')} ${suf}`; }
    function durationText(mins){ const h=Math.floor(mins/60), m=mins%60; return `${h} س ${m} د`; }

    function renderDevices(){
      devicesGrid.innerHTML='';
      DEVICES.forEach((dev,idx)=>{
        const open=openSessions[dev.id];
        const statusHtml=open?`<div class="status open">مفتوحة</div>`:`<div class="status idle">خالي</div>`;
        const infoHtml=open?`<div class="small">${format12FromISO(open.startISO)}</div><div class="small">نوع: ${open.mode==='single'?'فردي':'زوجي'}</div>`:`<div class="small">اضغط بدء</div>`;
        const controlsHtml=open?`<button class="end" data-action="end" data-idx="${idx}">إنهاء</button>`:`<button class="start" data-action="start" data-idx="${idx}">بدء جلسة</button>`;
        const wrapper=document.createElement('div');
        wrapper.className='device';
        wrapper.innerHTML=`<div class="title"><div><div class="dev-name">${dev.label}</div><div class="dev-sub">سعر/ساعة: ${RATES[dev.type].single}/${RATES[dev.type].double} ج</div></div>${statusHtml}</div><div>${infoHtml}</div><div class="controls">${controlsHtml}</div>`;
        devicesGrid.appendChild(wrapper);
      });
      openCountEl.textContent=Object.keys(openSessions).length;
    }

    // 🔥 مزامنة Firestore للجلسات المنتهية (Realtime)
    const q=query(collection(db,'sessions'), orderBy('createdAt','desc'));
    onSnapshot(q, snap=>{
      completedTbody.innerHTML='';
      snap.forEach(docSnap=>{
        const s=docSnap.data();
        const drinksTxt = (s.drinks && s.drinks.length) ? s.drinks.map(d=>`${d.name}×${d.qty}`).join(', ') : (s.drinks||'-');
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${s.deviceLabel||'-'}</td><td>${format12FromISO(s.startISO||s.start)}</td><td>${format12FromISO(s.endISO||s.end)}</td><td>${s.duration||'-'}</td><td>${drinksTxt}</td><td>${s.price||0} ج</td><td>${s.createdBy||'-'}</td>`;
        completedTbody.appendChild(tr);
      });
    });

    // events
    goAdminBtn.addEventListener('click', ()=> window.location.href='admin.html');
    logoutBtn.addEventListener('click', async ()=> { await signOut(auth); window.location.href='login.html'; });

    onAuthStateChanged(auth, user=>{ if(user) userEmailSpan.textContent=user.email; else window.location.href='login.html'; });

    (function init(){
      todayStr.textContent = new Date().toLocaleDateString('ar-EG');
      initLocal(); renderDevices();
    })();
  </script>
</body>
</html>
