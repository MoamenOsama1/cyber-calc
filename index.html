<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bianco Timer - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>
  <style>
    :root {
      --bg1: #050f18;
      --bg2: #0b1b2b;
      --card: #093f76;
      --accent: #00c853;
      --accent-2: #03a9f4;
      --muted: #a7b5c4;
      --danger: #ff5252;
      --glass: rgba(255, 255, 255, 0.04);
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
  
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }
  
    body {
      margin: 0;
      padding: 12px;
      font-family: "Cairo", "Segoe UI", sans-serif;
      color: #eaf2fb;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      direction: rtl;
      background: url('https://e0.pxfuel.com/wallpapers/239/293/desktop-wallpaper-playstation-background-playstation-blue-ps4.jpg') center/cover fixed, linear-gradient(135deg, var(--bg1), var(--bg2));
      backdrop-filter: blur(4px);
      min-height: 100vh;
    }
  
    .wrap { 
      max-width: 1100px; 
      margin: auto; 
      width: 100%;
    }
  
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
  
    h1 { 
      margin: 0; 
      font-size: clamp(18px, 5vw, 22px); 
      line-height: 1.3;
    }
    
    .small { 
      color: var(--muted); 
      font-size: clamp(12px, 3vw, 13px);
      line-height: 1.4;
    }
  
    .btn {
      background: var(--accent);
      border: none;
      color: #021018;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: 0.2s;
      font-size: 14px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover, .btn:focus { 
      transform: scale(1.05); 
      outline: none;
    }

    .btn.warning {
      background: #ff9800;
      color: #000;
    }
  
    .secondary {
      background: transparent;
      border: 1px solid var(--glass);
      color: var(--muted);
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .secondary:hover, .secondary:focus { 
      color: #fff; 
      border-color: #888; 
      outline: none;
    }
  
    .summary {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }
  
    .card {
      background: var(--card);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--glass);
      box-shadow: var(--shadow);
      transition: 0.2s;
      flex: 1;
      min-width: 120px;
      max-width: 180px;
    }
  
    .card:hover { transform: translateY(-2px); }
    .card.small { text-align: center; }
  
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    @media (max-width: 480px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
      }
    }
    
    @media (max-width: 360px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }
    }

    .device {
      background: var(--card);
      border: 1px solid var(--glass);
      border-radius: 12px;
      padding: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: 0.3s ease;
      min-height: 160px;
    }
  
    .device:hover { transform: translateY(-3px); }
  
    .device .title {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
  
    .dev-name { 
      font-weight: 800; 
      color: #ffffff; 
      font-size: 16px;
      line-height: 1.2;
    }
    
    .dev-sub { 
      font-size: 12px; 
      color: var(--muted); 
      margin-top: 4px;
      line-height: 1.3;
    }
  
    .status {
      padding: 6px 8px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
    }
  
    .open { background: #064f2b; color: #a8f7c1; }
    .idle { background: #09131eae; color: var(--muted); border: 1px solid rgba(255,255,255,0.05); }
  
    .controls {
      display: flex;
      gap: 6px;
      margin-top: auto;
    }
  
    .controls button {
      flex: 1;
      padding: 10px 8px;
      border-radius: 8px;
      border: none;
      font-weight: 800;
      touch-action: manipulation;
      cursor: pointer;
      font-size: 13px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  
    .start { background: var(--accent); color: #000000; }
    .add { background: var(--accent-2); color: #fff; }
    .end { background: var(--danger); color: #fff; }
  
    .sessions {
      margin-top: 20px;
      background: var(--card);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--glass);
      box-shadow: var(--shadow);
      overflow-x: auto;
    }
    
    .sessions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .sessions-header strong {
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      min-width: 600px;
    }
  
    th, td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 13px;
    }
  
    th { color: var(--muted); }
    
    @media (max-width: 768px) {
      th, td {
        padding: 8px 6px;
        font-size: 12px;
      }
    }

    footer {
      margin-top: 16px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding: 0 8px;
      line-height: 1.5;
    }
  
    /* Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
    .modal-back {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: all 0.2s;
      z-index: 1000;
      padding: 16px;
    }
  
    .modal-back.active { 
      visibility: visible; 
      opacity: 1; 
    }
  
    .modal {
      width: 100%;
      max-width: 360px;
      background: #081c2c;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--glass);
      box-shadow: var(--shadow);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 18px;
    }

    label { 
      font-size: 13px; 
      color: var(--muted); 
      display: block; 
      margin-top: 10px; 
      margin-bottom: 4px;
    }
    
    input, select {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05);
      background: #0f1b26 !important;
      color: #fff !important;
      font-size: 14px;
      min-height: 44px;
    }
    
    input:focus, select:focus { 
      outline: 2px solid var(--accent-2); 
    }
    
    .row {
      display: flex;
      gap: 10px;
    }
    
    .half {
      flex: 1;
    }
    
    .center {
      text-align: center;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .header-buttons {
        display: flex;
        gap: 8px;
        width: 100%;
        justify-content: space-between;
      }
      
      .header-buttons .btn,
      .header-buttons .secondary {
        flex: 1;
        font-size: 13px;
        padding: 10px 8px;
      }
      
      .summary {
        gap: 8px;
      }
      
      .card {
        min-width: 100px;
        padding: 10px;
      }
      
      .sessions {
        padding: 10px;
      }
      
      .modal {
        padding: 14px;
      }
    }
    
    @media (max-height: 500px) and (orientation: landscape) {
      .modal-back {
        align-items: flex-start;
        padding-top: 20px;
      }
      
      .modal {
        max-height: 80vh;
      }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
    .sync-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1001;
      display: none;
    }
    
    .session-updated {
      animation: highlight 2s ease;
    }
    
    .session-deleted {
      opacity: 0.6;
      background: rgba(229, 57, 53, 0.1) !important;
      text-decoration: line-through;
    }
    
    @keyframes highlight {
      0% { background: rgba(0, 200, 83, 0.3); }
      100% { background: transparent; }
    }
    
    .history-section {
      margin-top: 20px;
      background: var(--card);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--glass);
      box-shadow: var(--shadow);
    }
    
    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .tab-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: 0.2s;
    }
    
    .tab-btn.active {
      background: var(--accent);
      color: #000;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª */
    .expense-row {
      background: rgba(255, 87, 34, 0.05);
    }
    
    .financial-summary {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }


    /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØªØ§Øª */
.shift-report {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  padding: 15px;
  margin: 10px 0;
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.shift-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.shift-stat-item {
  text-align: center;
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

.shift-stat-value {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--accent);
  display: block;
}

.shift-stat-label {
  font-size: 0.8rem;
  color: var(--muted);
}

textarea {
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}
  </style>
  
</head>
<body>
  
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ® Bianco Timer - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h1>
        <div class="small">Ø¨Ù†Ø¬ + PS4 (1â€“6) + PS5 (7â€“15) â€” ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø¦Ù… + Ù…Ø²Ø§Ù…Ù†Ø© Firebase</div>
      </div>
      <div class="header-buttons">
        <div id="userEmail" class="small"></div>
        <button class="btn" id="goAdmin">ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</button>
        <button class="btn warning" id="clearDataBtn">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="secondary" id="syncBtn">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="secondary" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <!-- Ø¨Ø¹Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ header Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
<button class="btn warning" id="endShiftBtn">â° Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª</button>
      </div>
    </header>

    <section class="summary">
      <div class="card small"><div class="small">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div id="todayStr" style="font-weight:800;margin-top:6px"></div></div>
      <div class="card small"><div class="small">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div><div id="openCount" style="font-weight:800;margin-top:6px">0</div></div>
      <div class="card small"><div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ… (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</div><div id="todayRevenue" style="font-weight:800;margin-top:6px">0 Ø¬</div></div>
    </section>

    <section class="grid" id="devicesGrid"></section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
    <section class="history-section">
      <div class="sessions-header">
        <strong>ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</strong>
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="today">Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
          <button class="tab-btn" data-tab="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button>
        </div>
      </div>
      <table id="completedTable">
        <thead><tr><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù†</th><th>Ø¥Ù„Ù‰</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
    <section class="history-section">
      <div class="sessions-header">
        <strong>ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</strong>
        <button class="btn" id="addExpenseBtn">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
      </div>
      <table id="expensesTable">
        <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="financial-summary">
        <div style="display: flex; justify-content: space-between;">
          <span>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
          <span id="grossRevenue">0 Ø¬</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span>
          <span id="totalExpenses">0 Ø¬</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">
          <span>ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</span>
          <span id="netRevenue">0 Ø¬</span>
        </div>
      </div>
    </section>

    <footer>ğŸ’¾ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… + Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase. ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù.</footer>
  </div>

  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
  <div class="sync-indicator" id="syncIndicator">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© -->
  <div class="modal-back" id="modalStart">
    <div class="modal">
      <h3 class="center">â–¶ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©</h3>
      <label>Ø§Ù„Ø¬Ù‡Ø§Ø²</label><input id="startDevice" disabled />
      <label>Ø§Ø®ØªØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù„Ø³Ø©</label>
      <select id="sessionKind">
        <option value="open">Ø£ÙˆØ¨Ù† (Ù…ÙØªÙˆØ­Ø©)</option>
        <option value="set">Ø£Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</option>
      </select>
      <div id="endTimeRow" style="display:none">
        <label>ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (HH:MM)</label><input type="time" id="sessionEndTime" />
      </div>
      <label>Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨</label>
      <select id="playMode"><option value="single">ÙØ±Ø¯ÙŠ</option><option value="double">Ø²ÙˆØ¬ÙŠ</option></select>
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn" id="confirmStart">Ø§Ø¨Ø¯Ø£</button>
        <button class="secondary" id="cancelStart">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ -->
  <div class="modal-back" id="modalDrink">
    <div class="modal">
      <h3 class="center">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</h3>
      <label>Ø§Ø®ØªÙŠØ§Ø±</label>
      <select id="drinkSelect" class="drink">
        <option value="">Ø§Ø®ØªØ±...</option>
        <option value="Ø´Ø§ÙŠ|10">Ø´Ø§ÙŠ - 10 Ø¬</option>
        <option value="Ù‚Ù‡ÙˆØ©|15">Ù‚Ù‡ÙˆØ© - 15 Ø¬</option>
        <option value="Ø¥Ù†Ø¯ÙˆÙ…ÙŠ ØµØºÙŠØ±|15">Ø¥Ù†Ø¯ÙˆÙ…ÙŠ ØµØºÙŠØ± - 15 Ø¬</option>
        <option value="Ø¥Ù†Ø¯ÙˆÙ…ÙŠ ÙƒØ¨ÙŠØ±|25">Ø¥Ù†Ø¯ÙˆÙ…ÙŠ ÙƒØ¨ÙŠØ± - 25 Ø¬</option>
        <option value="Ø¨ÙŠØ¨Ø³ÙŠ|25">Ø¨ÙŠØ¨Ø³ÙŠ - 25 Ø¬</option>
        <option value="Ù…ØªÙ†ÙˆØ¹">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</option>
      </select>
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="drinkQty" type="number" min="1" value="1" />
      <label>Ù„Ø¬Ù‡Ø§Ø²</label><input id="drinkDevice" disabled />
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn" id="confirmAddDrink">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="secondary" id="cancelAddDrink">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© -->
  <div class="modal-back" id="modalEnd">
    <div class="modal">
      <h3 class="center">â±ï¸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
      <div class="small center" id="endDeviceLabel"></div>
      <div class="row">
        <div class="half"><label>Ù…Ù†</label><input id="endFrom" disabled /></div>
        <div class="half"><label>Ø¥Ù„Ù‰</label><input id="endTo" disabled /></div>
      </div>
      <label>Ø§Ù„Ù…Ø¯Ø©</label><input id="endDuration" disabled />
      <label>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label><input id="endDrinks" disabled />
      <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Ø¬Ù†ÙŠÙ‡)</label><input id="endTotal" disabled />
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn" id="confirmEnd">Ø§Ø­ÙØ¸ ÙˆØ§Ø­Ø³Ø¨</button>
        <button class="secondary" id="cancelEnd">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ -->
  <div class="modal-back" id="modalExpense">
    <div class="modal">
      <h3 class="center">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
      <input id="expenseName" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¨Ø§ØªØŒ ØµÙŠØ§Ù†Ø©ØŒ Ø¥Ù„Ø®" />
      <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)</label>
      <input id="expenseAmount" type="number" min="1" value="1" />
      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="btn" id="confirmAddExpense">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="secondary" id="cancelAddExpense">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<div class="modal-back" id="modalClearData">
  <div class="modal">
      <h3 class="center">ğŸš¨ ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
      <p class="center" style="color: var(--muted); margin-bottom: 20px; line-height: 1.5;">
          Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ <strong>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</strong>ØŸ<br>
          <strong style="color: #ff5252;">Ù‡Ø°Ø§ ÙŠØ´Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!</strong>
      </p>
      <div style="display:flex;gap:8px;margin-top:16px;">
          <button class="btn" style="background: #ff5252; width: 100%;" id="confirmClearData">Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          <button class="secondary" id="cancelClearData">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª -->
<div class="modal-back" id="modalEndShift">
  <div class="modal" style="max-width: 90%; max-height: 90vh;">
    <h3 class="center">â° Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª - ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„</h3>
    
    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="financial-summary" style="margin-bottom: 16px;">
      <h4 style="text-align: center; margin-bottom: 12px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙŠÙØª</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <div class="shift-stat-item">
          <div class="shift-stat-value" id="shiftCompletedSessions">0</div>
          <div class="shift-stat-label">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
        </div>
        <div class="shift-stat-item">
          <div class="shift-stat-value" id="shiftOpenSessions">0</div>
          <div class="shift-stat-label">Ø¬Ù„Ø³Ø§Øª Ù…ÙØªÙˆØ­Ø©</div>
        </div>
        <div class="shift-stat-item">
          <div class="shift-stat-value" id="shiftGrossRevenue">0 Ø¬</div>
          <div class="shift-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        </div>
        <div class="shift-stat-item">
          <div class="shift-stat-value" id="shiftTotalExpenses">0 Ø¬</div>
          <div class="shift-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
        </div>
        <div class="shift-stat-item">
          <div class="shift-stat-value" id="shiftNetRevenue">0 Ø¬</div>
          <div class="shift-stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª -->
    <div style="margin: 16px 0;">
      <h4 style="margin-bottom: 12px;">ğŸ® Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</h4>
      <div style="max-height: 300px; overflow-y: auto;">
        <table style="width: 100%; font-size: 12px;">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ù…Ù†</th>
              <th>Ø¥Ù„Ù‰</th>
              <th>Ø§Ù„Ù…Ø¯Ø©</th>
              <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
            </tr>
          </thead>
          <tbody id="shiftSessionsList"></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
    <div style="margin: 16px 0;">
      <h4 style="margin-bottom: 12px;">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h4>
      <div style="max-height: 200px; overflow-y: auto;">
        <table style="width: 100%; font-size: 12px;">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            </tr>
          </thead>
          <tbody id="shiftExpensesList"></tbody>
        </table>
      </div>
    </div>

    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <textarea id="shiftNotes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø´ÙŠÙØª..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); background: #0f1b26; color: white; min-height: 80px; font-family: inherit;"></textarea>

    <div style="display:flex;gap:8px;margin-top:16px;">
      <button class="btn" id="confirmEndShift" style="background: #ff9800;">âœ… ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª</button>
      <button class="btn" id="exportShiftReport">ğŸ“Š ØªØµØ¯ÙŠØ± Ù„Ø¥ÙƒØ³Ù„</button>
      <button class="secondary" id="cancelEndShift">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, updateDoc, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFI6W1mCbFsG8MfcGxWL0JonZtJ_7P6W0",
    authDomain: "bianco-playstation.firebaseapp.com",
    projectId: "bianco-playstation",
    storageBucket: "bianco-playstation.firebasestorage.app",
    messagingSenderId: "699813217029",
    appId: "1:699813217029:web:568e169371a2361358ad6c"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const RATES = { ping:{single:30,double:40}, ps4:{single:30,double:40}, ps5:{single:40,double:50} };
  const DEVICES = []; DEVICES.push({id:'ping',label:'Ping',type:'ping'}); for(let i=1;i<=6;i++) DEVICES.push({id:`ps${i}`,label:`PS4-${i}`,type:'ps4'}); for(let i=7;i<=15;i++) DEVICES.push({id:`ps${i}`,label:`PS5-${i}`,type:'ps5'});

  const STORAGE_KEY='biancoSessionsLocal';
  
  function getStorage(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}catch(e){return{}} }
  function setStorage(o){ localStorage.setItem(STORAGE_KEY,JSON.stringify(o)) }
  function todayKey(){ return new Date().toLocaleDateString('ar-EG') }

  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ù„Ù†ØµÙ Ø¬Ù†ÙŠÙ‡
  function roundToNearestFive(amount) {
      return Math.round(amount / 5) * 5;
  }

  let openSessions = {}, completedSessionsToday = [], allSessions = [], expensesToday = [];
  let currentTab = 'today';
  let dataClearDate = localStorage.getItem('dataClearDate') || '';

  // function initLocal(){ 
  //   const s = getStorage(); 
  //   const t = todayKey(); 
    
  //   if (!s[t]) s[t] = { open: {}, completed: [], expenses: [] }; 
    
  //   // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  //   // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø³ØªØ¨Ù‚Ù‰ Ù…Ø­ÙÙˆØ¸Ø© ÙˆÙ„Ø§ ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    
  //   setStorage(s); 
  //   openSessions = s[t].open || {}; 
  //   completedSessionsToday = s[t].completed || []; 
  //   expensesToday = s[t].expenses || [];
    
  //   // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  //   allSessions = [];
  //   Object.keys(s).forEach(date => {
  //       if (s[date].completed) {
  //           s[date].completed.forEach(session => {
  //               if (!session.isDeleted) {
  //                   allSessions.push({
  //                       ...session,
  //                       date: date,
  //                       isToday: date === t
  //                   });
  //               }
  //           });
  //       }
  //   });
  // }
  function initLocal(){ 
    const s = getStorage(); 
    const t = todayKey(); 
    
    if (!s[t]) s[t] = { open: {}, completed: [], expenses: [] }; 
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    if (s[t].completed) {
        const uniqueSessions = [];
        const sessionKeys = new Set();
        
        s[t].completed.forEach(session => {
            const sessionKey = session.id || 
                `${session.deviceLabel}_${session.startISO}_${session.endISO}_${session.price}_${session.mode}`;
            
            if (!sessionKeys.has(sessionKey)) {
                sessionKeys.add(sessionKey);
                uniqueSessions.push(session);
            }
        });
        
        s[t].completed = uniqueSessions;
    }
    
    setStorage(s); 
    openSessions = s[t].open || {}; 
    completedSessionsToday = s[t].completed || []; 
    expensesToday = s[t].expenses || [];
    
    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    allSessions = [];
    Object.keys(s).forEach(date => {
        if (s[date].completed) {
            s[date].completed.forEach(session => {
                if (!session.isDeleted) {
                    allSessions.push({
                        ...session,
                        date: date,
                        isToday: date === t
                    });
                }
            });
        }
    });
}
  // function persistLocal(){ 
  //   const s = getStorage(); 
  //   const t = todayKey(); 
    
  //   if (s[t] && s[t].completed) {
  //       const uniqueSessions = [];
  //       const sessionKeys = new Set();
        
  //       s[t].completed.forEach(session => {
  //           const sessionKey = session.id || 
  //               `${session.deviceLabel}_${session.startISO}_${session.endISO}`;
            
  //           if (!sessionKeys.has(sessionKey)) {
  //               sessionKeys.add(sessionKey);
  //               uniqueSessions.push(session);
  //           }
  //       });
        
  //       s[t].completed = uniqueSessions;
  //   }
    
  //   s[t] = { open: openSessions, completed: completedSessionsToday, expenses: expensesToday }; 
  //   setStorage(s); 
  //   initLocal();
  // }
  function persistLocal(){ 
    const s = getStorage(); 
    const t = todayKey(); 
    
    if (s[t] && s[t].completed) {
        const uniqueSessions = [];
        const sessionKeys = new Set();
        
        s[t].completed.forEach(session => {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù„Ø³Ø©
            const sessionKey = session.id || 
                `${session.deviceLabel}_${session.startISO}_${session.endISO}_${session.price}`;
            
            if (!sessionKeys.has(sessionKey)) {
                sessionKeys.add(sessionKey);
                uniqueSessions.push(session);
            } else {
                console.log('âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©:', session.deviceLabel);
            }
        });
        
        s[t].completed = uniqueSessions;
    }
    
    s[t] = { open: openSessions, completed: completedSessionsToday, expenses: expensesToday }; 
    setStorage(s); 
    initLocal();
}
  // DOM elements
  const devicesGrid = document.getElementById('devicesGrid');
  const todayStr = document.getElementById('todayStr');
  const openCountEl = document.getElementById('openCount');
  const todayRevenueEl = document.getElementById('todayRevenue');
  const completedTbody = document.querySelector('#completedTable tbody');
  const userEmailSpan = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const goAdminBtn = document.getElementById('goAdmin');
  const clearDataBtn = document.getElementById('clearDataBtn');
  const syncBtn = document.getElementById('syncBtn');
  const syncIndicator = document.getElementById('syncIndicator');
  const tabButtons = document.querySelectorAll('.tab-btn');
  const modalClearData = document.getElementById('modalClearData');
  const confirmClearData = document.getElementById('confirmClearData');
  const cancelClearData = document.getElementById('cancelClearData');

  // expense elements
  const modalExpense = document.getElementById('modalExpense');
  const expenseName = document.getElementById('expenseName');
  const expenseAmount = document.getElementById('expenseAmount');
  const confirmAddExpense = document.getElementById('confirmAddExpense');
  const cancelAddExpense = document.getElementById('cancelAddExpense');
  const addExpenseBtn = document.getElementById('addExpenseBtn');

  // modals
  const modalStart = document.getElementById('modalStart');
  const startDevice = document.getElementById('startDevice');
  const sessionKind = document.getElementById('sessionKind');
  const sessionEndTime = document.getElementById('sessionEndTime');
  const playMode = document.getElementById('playMode');
  const confirmStart = document.getElementById('confirmStart');
  const cancelStart = document.getElementById('cancelStart');
  const endTimeRow = document.getElementById('endTimeRow');

  const modalDrink = document.getElementById('modalDrink');
  const drinkSelect = document.getElementById('drinkSelect');
  const drinkQty = document.getElementById('drinkQty');
  const drinkDevice = document.getElementById('drinkDevice');
  const confirmAddDrink = document.getElementById('confirmAddDrink');
  const cancelAddDrink = document.getElementById('cancelAddDrink');

  const modalEnd = document.getElementById('modalEnd');
  const endDeviceLabel = document.getElementById('endDeviceLabel');
  const endFrom = document.getElementById('endFrom');
  const endTo = document.getElementById('endTo');
  const endDuration = document.getElementById('endDuration');
  const endDrinks = document.getElementById('endDrinks');
  const endTotal = document.getElementById('endTotal');
  const confirmEnd = document.getElementById('confirmEnd');
  const cancelEnd = document.getElementById('cancelEnd');


  // Ø¹Ù†Ø§ØµØ± ÙˆØ²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª
const endShiftBtn = document.getElementById('endShiftBtn');
const modalEndShift = document.getElementById('modalEndShift');
const confirmEndShift = document.getElementById('confirmEndShift');
const cancelEndShift = document.getElementById('cancelEndShift');
const shiftCompletedSessions = document.getElementById('shiftCompletedSessions');
const shiftOpenSessions = document.getElementById('shiftOpenSessions');
const shiftGrossRevenue = document.getElementById('shiftGrossRevenue');
const shiftTotalExpenses = document.getElementById('shiftTotalExpenses');
const shiftNetRevenue = document.getElementById('shiftNetRevenue');
const shiftNotes = document.getElementById('shiftNotes');






// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª
function openEndShiftModal() {
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  const completedCount = completedSessionsToday.length;
  const openCount = Object.keys(openSessions).length;
  
  let grossRevenue = 0;
  completedSessionsToday.forEach(s => grossRevenue += Number(s.price || 0));
  
  const totalExpenses = expensesToday.reduce((sum, expense) => sum + Number(expense.amount), 0);
  const netRevenue = grossRevenue - totalExpenses;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  shiftCompletedSessions.textContent = completedCount;
  shiftOpenSessions.textContent = openCount;
  shiftGrossRevenue.textContent = `${grossRevenue.toFixed(0)} Ø¬`;
  shiftTotalExpenses.textContent = `${totalExpenses.toFixed(0)} Ø¬`;
  shiftNetRevenue.textContent = `${netRevenue.toFixed(0)} Ø¬`;
  shiftNotes.value = '';
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
  renderShiftSessions();
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  renderShiftExpenses();
  
  modalEndShift.classList.add('active');
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function renderShiftSessions() {
  shiftSessionsList.innerHTML = '';
  
  if (completedSessionsToday.length === 0) {
    shiftSessionsList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 10px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</td></tr>';
    return;
  }
  
  completedSessionsToday.forEach(session => {
    const tr = document.createElement('tr');
    const drinksTxt = Array.isArray(session.drinks) 
      ? session.drinks.map(d => `${d.name}Ã—${d.qty}`).join(', ')
      : (session.drinks || '-');
    
    tr.innerHTML = `
      <td>${session.deviceLabel || '-'}</td>
      <td>${session.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ'}</td>
      <td>${format12FromISO(session.startISO)}</td>
      <td>${format12FromISO(session.endISO)}</td>
      <td>${session.duration || '-'}</td>
      <td>${drinksTxt}</td>
      <td>${session.price || 0} Ø¬</td>
    `;
    shiftSessionsList.appendChild(tr);
  });
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function renderShiftExpenses() {
  shiftExpensesList.innerHTML = '';
  
  if (expensesToday.length === 0) {
    shiftExpensesList.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</td></tr>';
    return;
  }
  
  expensesToday.forEach(expense => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${expense.name}</td>
      <td>${expense.amount} Ø¬</td>
      <td>${new Date().toLocaleDateString('ar-EG')}</td>
    `;
    shiftExpensesList.appendChild(tr);
  });
}

// Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª Ù„Ø¥ÙƒØ³Ù„
function exportShiftToExcel() {
  const rows = [
    ['ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª - Bianco Timer'],
    ['Ø§Ù„ØªØ§Ø±ÙŠØ®', todayKey()],
    ['ÙˆÙ‚Øª Ø§Ù„ØªØµØ¯ÙŠØ±', new Date().toLocaleString('ar-EG')],
    ['Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', auth.currentUser.email],
    [''],
    ['Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ'],
    ['Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©', completedSessionsToday.length],
    ['Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©', Object.keys(openSessions).length],
    ['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©', calculateGrossRevenue() + ' Ø¬'],
    ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', calculateTotalExpenses() + ' Ø¬'],
    ['ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', calculateNetRevenue() + ' Ø¬'],
    [''],
    ['Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©'],
    ['Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø§Ù„Ù†ÙˆØ¹', 'Ù…Ù†', 'Ø¥Ù„Ù‰', 'Ø§Ù„Ù…Ø¯Ø©', 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'Ø§Ù„Ø³Ø¹Ø±']
  ];
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù„Ø³Ø§Øª
  completedSessionsToday.forEach(session => {
    const drinksTxt = Array.isArray(session.drinks) 
      ? session.drinks.map(d => `${d.name}Ã—${d.qty}`).join(' | ')
      : (session.drinks || '-');
    
    rows.push([
      session.deviceLabel || '-',
      session.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ',
      format12FromISO(session.startISO),
      format12FromISO(session.endISO),
      session.duration || '-',
      drinksTxt,
      session.price || 0
    ]);
  });
  
  rows.push(['']);
  rows.push(['Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª']);
  rows.push(['Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ØªØ§Ø±ÙŠØ®']);
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  expensesToday.forEach(expense => {
    rows.push([
      expense.name,
      expense.amount + ' Ø¬',
      new Date().toLocaleDateString('ar-EG')
    ]);
  });
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV
  const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
  const bom = "\uFEFF";
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `shift_report_${todayKey().replace(/\//g, '-')}_${new Date().getTime()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª
function calculateGrossRevenue() {
  let total = 0;
  completedSessionsToday.forEach(s => total += Number(s.price || 0));
  return total;
}

function calculateTotalExpenses() {
  return expensesToday.reduce((sum, expense) => sum + Number(expense.amount), 0);
}

function calculateNetRevenue() {
  return calculateGrossRevenue() - calculateTotalExpenses();
}

// Event Listener Ù„Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
exportShiftReport.addEventListener('click', exportShiftToExcel);
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª ÙÙŠ Firebase
async function saveShiftReportToFirebase() {
  try {
    const user = auth.currentUser;
    const now = new Date();
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    let grossRevenue = 0;
    completedSessionsToday.forEach(s => grossRevenue += Number(s.price || 0));
    
    const totalExpenses = expensesToday.reduce((sum, expense) => sum + Number(expense.amount), 0);
    const netRevenue = grossRevenue - totalExpenses;
    
    const shiftReport = {
      userEmail: user.email,
      userName: user.displayName || user.email.split('@')[0],
      date: todayKey(),
      timestamp: now.toISOString(),
      completedSessions: completedSessionsToday.length,
      openSessions: Object.keys(openSessions).length,
      grossRevenue: grossRevenue,
      totalExpenses: totalExpenses,
      netRevenue: netRevenue,
      sessions: completedSessionsToday,
      expenses: expensesToday,
      notes: shiftNotes.value.trim(),
      shiftDuration: '8 Ø³Ø§Ø¹Ø§Øª', // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙŠÙØªØ§Øª Ù„Ø¯ÙŠÙƒ
      status: 'completed'
    };
    
    // Ø­ÙØ¸ ÙÙŠ Firebase
    await addDoc(collection(db, 'shiftReports'), shiftReport);
    
    console.log('âœ… ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª Ø¨Ù†Ø¬Ø§Ø­');
    return true;
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª:', error);
    throw error;
  }
}

// Event Listeners Ù„Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª
endShiftBtn.addEventListener('click', openEndShiftModal);

confirmEndShift.addEventListener('click', async () => {
  try {
    showSyncIndicator();
    
    // Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª
    await saveShiftReportToFirebase();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    alert('âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©');
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    modalEndShift.classList.remove('active');
    
    hideSyncIndicator();
    
  } catch (error) {
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´ÙŠÙØª: ' + error.message);
    hideSyncIndicator();
  }
});

cancelEndShift.addEventListener('click', () => {
  modalEndShift.classList.remove('active');
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
modalEndShift.addEventListener('click', (e) => {
  if (e.target === modalEndShift) {
    modalEndShift.classList.remove('active');
  }
});

  // helpers
  function nowISO(){ return new Date().toISOString(); }
  function diffMinutes(startISO,endISO){ return Math.max(0, Math.floor((new Date(endISO)-new Date(startISO))/60000)); }
  function format12FromISO(iso){ const d=new Date(iso); if(isNaN(d)) return '-'; let h=d.getHours(), m=d.getMinutes(), suf=h>=12?'Ù…Ø³Ø§Ø¡Ù‹':'ØµØ¨Ø§Ø­Ù‹Ø§', hh=h%12||12; return `${hh}:${m.toString().padStart(2,'0')} ${suf}`; }
  function durationText(mins){ const h=Math.floor(mins/60), m=mins%60; return `${h} Ø³ ${m} Ø¯`; }
  function isoFromTimeStr(timeStr){ const [hh,mm]=timeStr.split(':').map(Number); const now=new Date(); const d=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,0); if(d<=now) d.setDate(d.getDate()+1); return d.toISOString(); }

  // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  function showSyncIndicator() {
      syncIndicator.style.display = 'block';
  }

  function hideSyncIndicator() {
      setTimeout(() => {
          syncIndicator.style.display = 'none';
      }, 1000);
  }

  function showNotification(message) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--accent);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          z-index: 10000;
          box-shadow: var(--shadow);
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
          notification.remove();
      }, 3000);
  }

  // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Firebase
  async function saveOpenSessionToFirebase(session) {
      try {
          const openSessionsRef = collection(db, 'openSessions');
          
          if (session.firebaseId) {
              await updateDoc(doc(db, 'openSessions', session.firebaseId), session);
          } else {
              const q = query(openSessionsRef, where("deviceId", "==", session.deviceId));
              const querySnapshot = await getDocs(q);
              
              if (!querySnapshot.empty) {
                  const docId = querySnapshot.docs[0].id;
                  await updateDoc(doc(db, 'openSessions', docId), session);
              } else {
                  const docRef = await addDoc(openSessionsRef, session);
                  session.firebaseId = docRef.id;
              }
          }
      } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©:', error);
      }
  }

  async function removeOpenSessionFromFirebase(deviceId) {
      try {
          const openSessionsRef = collection(db, 'openSessions');
          const q = query(openSessionsRef, where("deviceId", "==", deviceId));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
             // const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
             // await Promise.all(deletePromises);
          }
      } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©:', error);
      }
  }

  // render functions
  function renderDevices(){ 
      devicesGrid.innerHTML=''; 
      DEVICES.forEach((dev,idx)=>{ 
          const open=openSessions[dev.id]; 
          const statusHtml=open?`<div class="status open">Ù…ÙØªÙˆØ­Ø©</div>`:`<div class="status idle">Ø®Ø§Ù„ÙŠ</div>`; 
          const infoHtml=open?`<div class="small">${format12FromISO(open.startISO)} ${open.scheduledEndISO? 'â†’ ' + format12FromISO(open.scheduledEndISO): ''}</div><div class="small">Ù†ÙˆØ¹: ${open.mode==='single'?'ÙØ±Ø¯ÙŠ':'Ø²ÙˆØ¬ÙŠ'}</div>`:`<div class="small">Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡</div>`; 
          const controlsHtml=open?`<button class="end" data-action="end" data-idx="${idx}">Ø¥Ù†Ù‡Ø§Ø¡</button><button class="add" data-action="add" data-idx="${idx}">â• Ø·Ù„Ø¨</button>`:`<button class="start" data-action="start" data-idx="${idx}">Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©</button>`; 
          const wrapper=document.createElement('div'); 
          wrapper.className='device'; 
          wrapper.innerHTML=`<div class="title"><div><div class="dev-name">${dev.label}</div><div class="dev-sub">Ø³Ø¹Ø±/Ø³Ø§Ø¹Ø©: ${RATES[dev.type].single}/${RATES[dev.type].double} Ø¬</div></div>${statusHtml}</div><div>${infoHtml}</div><div class="controls">${controlsHtml}</div>`; 
          devicesGrid.appendChild(wrapper); 
      }); 
      updateSummary(); 
      renderCompleted(); 
      renderExpenses();
  }

  function updateSummary(){ 
      openCountEl.textContent=Object.keys(openSessions).length; 
      let total=0; 
      completedSessionsToday.forEach(s=> total += Number(s.price||0)); 


      // const now = nowISO(); 
      // Object.values(openSessions).forEach(s=>{ 
      //     const mins = diffMinutes(s.startISO, now); 
      //     const rate = RATES[s.rateType][s.mode]; 
      //     const hoursPrice = (mins/60)*rate; 
      //     let drinksTotal = 0;
      //     if (Array.isArray(s.drinks)) {
      //         drinksTotal = s.drinks.reduce((a,b)=>a+(b.price*b.qty),0);
      //     }
      //     total += hoursPrice + drinksTotal; 
      // }); 
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
      const roundedTotal = roundToNearestFive(total);
      todayRevenueEl.textContent = `${Number(roundedTotal.toFixed(0))} Ø¬`; 
  }

  // function renderCompleted() {
  //     completedTbody.innerHTML = '';
  //     const sessionsToShow = currentTab === 'today' ? completedSessionsToday : allSessions;
      
  //     // ØªØµÙÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  //     const filteredSessions = sessionsToShow.filter(session => !session.isDeleted);
      
  //     filteredSessions.slice().reverse().forEach((s, index) => {
  //         const tr = document.createElement('tr');
  //         if (s.updatedByAdmin) {
  //             tr.classList.add('session-updated');
  //         }

  //         const drinksTxt = Array.isArray(s.drinks)
  //             ? s.drinks.map(d => `${d.name}Ã—${d.qty}`).join(', ')
  //             : (typeof s.drinks === 'string' && s.drinks.trim() !== ''
  //                 ? s.drinks
  //                 : '-');

  //         const status = s.updatedByAdmin ? 
  //             '<span style="color: var(--accent);">ğŸ”„ Ù…Ø­Ø¯Ø«</span>' : 
  //             '<span style="color: var(--muted);">âœ… Ù…Ø­ÙÙˆØ¸</span>';

  //         tr.innerHTML = `
  //             <td>${s.deviceLabel || '-'}</td>
  //             <td>${s.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ'}</td>
  //             <td>${format12FromISO(s.startISO)}</td>
  //             <td>${format12FromISO(s.endISO)}</td>
  //             <td>${s.duration || '-'}</td>
  //             <td>${drinksTxt}</td>
  //             <td>${s.price || 0} Ø¬</td>
  //             <td>${status}</td>
  //         `;
  //         completedTbody.appendChild(tr);
  //     });
  // }
  function renderCompleted() {
    completedTbody.innerHTML = '';
    const sessionsToShow = currentTab === 'today' ? completedSessionsToday : allSessions;
    
    // ØªØµÙÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© ÙÙ‚Ø·
    const latestSessions = new Map();
    
    sessionsToShow.filter(session => !session.isDeleted).forEach(session => {
        const key = `${session.deviceLabel}_${session.startISO}_${session.endISO}`;
        
        if (!latestSessions.has(key) || 
            (session.updatedByAdmin && !latestSessions.get(key).updatedByAdmin) ||
            (session.lastUpdate > (latestSessions.get(key).lastUpdate || ''))) {
            latestSessions.set(key, session);
        }
    });
    
    const filteredSessions = Array.from(latestSessions.values());
    
    filteredSessions.slice().reverse().forEach((s, index) => {
        const tr = document.createElement('tr');
        if (s.updatedByAdmin) {
            tr.classList.add('session-updated');
        }

        const drinksTxt = Array.isArray(s.drinks)
            ? s.drinks.map(d => `${d.name}Ã—${d.qty}`).join(', ')
            : (typeof s.drinks === 'string' && s.drinks.trim() !== ''
                ? s.drinks
                : '-');

        const status = s.updatedByAdmin ? 
            '<span style="color: var(--accent);">ğŸ”„ Ù…Ø­Ø¯Ø«</span>' : 
            '<span style="color: var(--muted);">âœ… Ù…Ø­ÙÙˆØ¸</span>';

        tr.innerHTML = `
            <td>${s.deviceLabel || '-'}</td>
            <td>${s.mode === 'double' ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ'}</td>
            <td>${format12FromISO(s.startISO)}</td>
            <td>${format12FromISO(s.endISO)}</td>
            <td>${s.duration || '-'}</td>
            <td>${drinksTxt}</td>
            <td>${s.price || 0} Ø¬</td>
            <td>${status}</td>
        `;
        completedTbody.appendChild(tr);
    });
}
  function renderExpenses() {
    const expensesTbody = document.querySelector('#expensesTable tbody');
    expensesTbody.innerHTML = '';
    
    expensesToday.forEach((expense, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${expense.name}</td>
        <td>${expense.amount} Ø¬</td>
        <td>${new Date().toLocaleDateString('ar-EG')}</td>
        <td><button class="danger" data-expense-index="${index}" style="padding: 4px 8px; font-size: 12px;">Ø­Ø°Ù</button></td>
      `;
      expensesTbody.appendChild(tr);
    });
    
    updateRevenueSummary();
  }

  function updateRevenueSummary() {
    const grossRevenueEl = document.getElementById('grossRevenue');
    const totalExpensesEl = document.getElementById('totalExpenses');
    const netRevenueEl = document.getElementById('netRevenue');
    
    let totalRevenue = 0;
    completedSessionsToday.forEach(s => totalRevenue += Number(s.price || 0));
    

    // const now = nowISO();
    // Object.values(openSessions).forEach(s => {
    //   const mins = diffMinutes(s.startISO, now);
    //   const rate = RATES[s.rateType][s.mode];
    //   const hoursPrice = (mins / 60) * rate;
    //   let drinksTotal = 0;
    //   if (Array.isArray(s.drinks)) {
    //     drinksTotal = s.drinks.reduce((a, b) => a + (b.price * b.qty), 0);
    //   }
    //   totalRevenue += hoursPrice + drinksTotal;
    // });
    
    const totalExpenses = expensesToday.reduce((sum, expense) => sum + Number(expense.amount), 0);
    const netRevenue = totalRevenue - totalExpenses;
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    const roundedGrossRevenue = roundToNearestFive(totalRevenue);
    const roundedNetRevenue = roundToNearestFive(netRevenue);
    
    grossRevenueEl.textContent = `${Number(roundedGrossRevenue.toFixed(0))} Ø¬`;
    totalExpensesEl.textContent = `${Number(totalExpenses.toFixed(0))} Ø¬`;
    netRevenueEl.textContent = `${Number(roundedNetRevenue.toFixed(0))} Ø¬`;
  }

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ
async function clearAllDataPermanently() {
    if (!confirm('ğŸš¨âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nÙ‡Ø°Ø§ Ø³ÙŠØ­Ø°Ù:\nâ€¢ ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©\nâ€¢ ÙƒÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª\nâ€¢ ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø§Ø¨Ù‚\n\nÙˆÙ„ÙƒÙ† Ø³ÙŠØ­ØªÙØ¸ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©!')) {
        return;
    }
    
    try {
        showSyncIndicator();
        
        // 1. Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ù…Ù†Ø¹ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        const clearTimestamp = new Date().toISOString();
        localStorage.setItem('dataClearDate', clearTimestamp);
        dataClearDate = clearTimestamp;
        
        // 2. Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø­
        const currentOpenSessions = { ...openSessions };
        
        // 3. Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        localStorage.removeItem(STORAGE_KEY);
        
        // 4. Ø¥Ù†Ø´Ø§Ø¡ ØªØ®Ø²ÙŠÙ† Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        const newStorage = {};
        const today = todayKey();
        newStorage[today] = { 
            open: currentOpenSessions, 
            completed: [], 
            expenses: [] 
        };
        
        // 5. Ø­ÙØ¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newStorage));
        
        // 6. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©)
        openSessions = currentOpenSessions;
        completedSessionsToday = [];
        allSessions = [];
        expensesToday = [];
        
        // 7. ğŸ”¥ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        setTimeout(() => {
            // 8. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            initLocal();
            renderDevices();
            
            hideSyncIndicator();
            
            modalClearData.classList.remove('active');
            alert('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­\nØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©');
            
            // 9. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
            setTimeout(() => {
                location.reload();
            }, 1000);
        }, 2000); // Ø§Ù†ØªØ¸Ø§Ø± 2 Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø³Ø­
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        hideSyncIndicator();
    }
}

// ========== Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase ==========

// // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
// const sessionsUpdatesQuery = query(collection(db, 'sessionUpdates'), orderBy('updatedAt', 'desc'));
// onSnapshot(sessionsUpdatesQuery, (snapshot) => {
//     showSyncIndicator();
//     let hasChanges = false;
//     const storage = getStorage();
    
//     snapshot.docChanges().forEach((change) => {
//         const update = change.doc.data();
        
//         // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
//         if (dataClearDate && new Date(update.updatedAt) < new Date(dataClearDate)) {
//             return;
//         }
        
//         if (change.type === "added" || change.type === "modified") {
//             // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
//             if (update.updateType === 'session_edit' && !update.isDeleted) {
//                 Object.keys(storage).forEach(date => {
//                     storage[date].completed = storage[date].completed.map(session => {
//                         const matches = 
//                             (update.sessionId && session.id === update.sessionId) ||
//                             (session.deviceLabel === update.originalDeviceLabel &&
//                              session.startISO === update.originalStartISO);
                        
//                         if (matches) {
//                             hasChanges = true;
//                             console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†:', session.deviceLabel);
//                             return {
//                                 ...session,
//                                 deviceLabel: update.deviceLabel || session.deviceLabel,
//                                 price: update.price !== undefined ? update.price : session.price,
//                                 drinks: update.drinks || session.drinks,
//                                 mode: update.mode || session.mode,
//                                 duration: update.duration || session.duration,
//                                 updatedByAdmin: true,
//                                 lastUpdate: new Date().toISOString()
//                             };
//                         }
//                         return session;
//                     });
//                 });
//             }
            
//             // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª
//             if (update.updateType === 'session_delete' && update.isDeleted) {
//                 Object.keys(storage).forEach(date => {
//                     const originalLength = storage[date].completed.length;
//                     storage[date].completed = storage[date].completed.filter(session => {
//                         const matches = 
//                             (update.sessionId && session.id === update.sessionId) ||
//                             (session.deviceLabel === update.originalDeviceLabel &&
//                              session.startISO === update.originalStartISO);
                        
//                         if (matches) {
//                             console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù„Ø³Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†:', session.deviceLabel);
//                             return false;
//                         }
//                         return true;
//                     });
                    
//                     if (storage[date].completed.length !== originalLength) {
//                         hasChanges = true;
//                     }
//                 });
//             }
//         }
//     });
    
//     if (hasChanges) {
//         setStorage(storage);
//         initLocal();
//         renderDevices();
//         showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
//     }
//     hideSyncIndicator();
// });

// // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù…Ø³ÙˆØ­Ø©
// const sessionsQuery = query(collection(db, 'sessions'), orderBy('createdAt', 'desc'));
// onSnapshot(sessionsQuery, (snapshot) => {
//     showSyncIndicator();
//     const storage = getStorage();
//     let hasUpdates = false;
    
//     snapshot.forEach(doc => {
//         const firebaseSession = { id: doc.id, ...doc.data() };
        
//         // ğŸ”¥ ÙÙ„ØªØ±Ø©: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ù…Ø³Ø­Ù‡Ø§
//         const sessionDate = firebaseSession.createdAt || firebaseSession.startISO;
//         if (dataClearDate && new Date(sessionDate) < new Date(dataClearDate)) {
//             console.log('â© ØªØ¬Ø§Ù‡Ù„ Ø¬Ù„Ø³Ø© Ù‚Ø¯ÙŠÙ…Ø© ØªÙ… Ù…Ø³Ø­Ù‡Ø§:', firebaseSession.deviceLabel);
//             return;
//         }
        
//         const sessionDateStr = firebaseSession.date || todayKey();
        
//         if (!storage[sessionDateStr]) {
//             storage[sessionDateStr] = { open: {}, completed: [] };
//         }
        
//         const existingIndex = storage[sessionDateStr].completed.findIndex(
//             s => s.id === firebaseSession.id
//         );
        
//         if (existingIndex === -1) {
//             const isDuplicate = storage[sessionDateStr].completed.some(s => 
//                 s.deviceLabel === firebaseSession.deviceLabel &&
//                 s.startISO === firebaseSession.startISO &&
//                 s.endISO === firebaseSession.endISO
//             );
            
//             if (!isDuplicate) {
//                 storage[sessionDateStr].completed.push(firebaseSession);
//                 hasUpdates = true;
//             }
//         } else {
//             const existing = storage[sessionDateStr].completed[existingIndex];
//             if (JSON.stringify(existing) !== JSON.stringify(firebaseSession)) {
//                 storage[sessionDateStr].completed[existingIndex] = {
//                     ...firebaseSession,
//                     updatedByAdmin: true,
//                     lastUpdate: new Date().toISOString()
//                 };
//                 hasUpdates = true;
//             }
//         }
//     });
    
//     if (hasUpdates) {
//         setStorage(storage);
//         initLocal();
//         renderDevices();
//         showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
//     }
//     hideSyncIndicator();
// });
/// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©
const sessionsUpdatesQuery = query(collection(db, 'sessionUpdates'), orderBy('updatedAt', 'desc'));
onSnapshot(sessionsUpdatesQuery, (snapshot) => {
    showSyncIndicator();
    let hasChanges = false;
    const storage = getStorage();
    const today = todayKey();
    
    snapshot.docChanges().forEach((change) => {
        const update = change.doc.data();
        
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        if (dataClearDate && new Date(update.updatedAt) < new Date(dataClearDate)) {
            return;
        }
        
        if (change.type === "added" || change.type === "modified") {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            if (update.updateType === 'session_edit' && !update.isDeleted) {
                console.log('ğŸ”„ Ø§Ø³ØªÙ„Ø§Ù… ØªØ­Ø¯ÙŠØ« Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†:', update.deviceLabel);
                
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¹Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                Object.keys(storage).forEach(date => {
                    const sessionIndex = storage[date].completed.findIndex(session => 
                        session.deviceLabel === update.originalDeviceLabel &&
                        session.startISO === update.originalStartISO &&
                        session.endISO === update.originalEndISO
                    );
                    
                    if (sessionIndex !== -1) {
                        console.log('âœ… ÙˆØ¬Ø¯Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«:', update.originalDeviceLabel);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                        storage[date].completed[sessionIndex] = {
                            ...storage[date].completed[sessionIndex],
                            deviceLabel: update.deviceLabel || update.originalDeviceLabel,
                            price: update.price !== undefined ? update.price : update.originalPrice,
                            drinks: update.drinks || storage[date].completed[sessionIndex].drinks,
                            mode: update.mode || storage[date].completed[sessionIndex].mode,
                            duration: update.duration || storage[date].completed[sessionIndex].duration,
                            updatedByAdmin: true,
                            lastUpdate: new Date().toISOString(),
                            id: update.sessionId || storage[date].completed[sessionIndex].id
                        };
                        
                        hasChanges = true;
                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©:', update.deviceLabel);
                    }
                });
            }
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª
            if (update.updateType === 'session_delete' && update.isDeleted) {
                console.log('ğŸ—‘ï¸ Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø­Ø°Ù Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†:', update.originalDeviceLabel);
                
                Object.keys(storage).forEach(date => {
                    const originalLength = storage[date].completed.length;
                    storage[date].completed = storage[date].completed.filter(session => {
                        const matches = 
                            (update.sessionId && session.id === update.sessionId) ||
                            (session.deviceLabel === update.originalDeviceLabel &&
                             session.startISO === update.originalStartISO &&
                             session.endISO === update.originalEndISO);
                        
                        if (matches) {
                            console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†:', session.deviceLabel);
                            return false;
                        }
                        return true;
                    });
                    
                    if (storage[date].completed.length !== originalLength) {
                        hasChanges = true;
                    }
                });
            }
        }
    });
    
    if (hasChanges) {
        setStorage(storage);
        initLocal();
        renderDevices();
        showNotification('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
    }
    hideSyncIndicator();
});

// Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
function cleanDuplicateSessions() {
    const s = getStorage();
    let totalRemoved = 0;
    
    Object.keys(s).forEach(date => {
        if (s[date].completed) {
            const uniqueSessions = [];
            const sessionKeys = new Set();
            
            s[date].completed.forEach(session => {
                const sessionKey = session.id || 
                    `${session.deviceLabel}_${session.startISO}_${session.endISO}_${session.price}_${session.mode}`;
                
                if (!sessionKeys.has(sessionKey)) {
                    sessionKeys.add(sessionKey);
                    uniqueSessions.push(session);
                } else {
                    totalRemoved++;
                    console.log('ğŸ§¹ Ø­Ø°Ù Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©:', session.deviceLabel);
                }
            });
            
            s[date].completed = uniqueSessions;
        }
    });
    
    setStorage(s);
    
    if (totalRemoved > 0) {
        alert(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${totalRemoved} Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©`);
        initLocal();
        renderDevices();
    } else {
        alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…ÙƒØ±Ø±Ø©');
    }
}

// // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© globally Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† console
// window.cleanDuplicateSessions = cleanDuplicateSessions;
// // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
// function cleanDuplicateSessions() {
//     const s = getStorage();
//     let totalRemoved = 0;
    
//     Object.keys(s).forEach(date => {
//         if (s[date].completed) {
//             const uniqueSessions = [];
//             const sessionKeys = new Set();
            
//             s[date].completed.forEach(session => {
//                 const sessionKey = session.id || 
//                     `${session.deviceLabel}_${session.startISO}_${session.endISO}_${session.price}_${session.mode}`;
                
//                 if (!sessionKeys.has(sessionKey)) {
//                     sessionKeys.add(sessionKey);
//                     uniqueSessions.push(session);
//                 } else {
//                     totalRemoved++;
//                     console.log('ğŸ§¹ Ø­Ø°Ù Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©:', session.deviceLabel);
//                 }
//             });
            
//             s[date].completed = uniqueSessions;
//         }
//     });
    
//     setStorage(s);
    
//     if (totalRemoved > 0) {
//         alert(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${totalRemoved} Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø©`);
//         initLocal();
//         renderDevices();
//     } else {
//         alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…ÙƒØ±Ø±Ø©');
//     }
// }

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙÙŠ Ø§Ù„Ù€ admin Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡ Ù…Ù† console
// cleanDuplicateSessions();
// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù…Ø³ÙˆØ­Ø©
const updatesQuery = query(collection(db, 'sessionUpdates'), orderBy('updatedAt', 'desc'));
onSnapshot(updatesQuery, (snapshot) => {
    showSyncIndicator();
    const storage = getStorage();
    let hasChanges = false;
    
    snapshot.docChanges().forEach((change) => {
        const update = change.doc.data();
        
        // ğŸ”¥ ÙÙ„ØªØ±Ø©: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªÙ… Ù…Ø³Ø­Ù‡Ø§
        if (dataClearDate && new Date(update.updatedAt) < new Date(dataClearDate)) {
            console.log('â© ØªØ¬Ø§Ù‡Ù„ ØªØ­Ø¯ÙŠØ« Ù‚Ø¯ÙŠÙ… ØªÙ… Ù…Ø³Ø­Ù‡:', update.updateType);
            return;
        }
        
        if (change.type === "added" || change.type === "modified") {
            if (update.updateType === 'session_delete' && update.isDeleted) {
                Object.keys(storage).forEach(date => {
                    const originalLength = storage[date].completed.length;
                    storage[date].completed = storage[date].completed.filter(session => {
                        const matches = 
                            (update.sessionId && session.id === update.sessionId) ||
                            (session.deviceLabel === update.originalDeviceLabel &&
                             session.startISO === update.originalStartISO);
                        
                        if (matches) {
                            return false;
                        }
                        return true;
                    });
                    
                    if (storage[date].completed.length !== originalLength) {
                        hasChanges = true;
                    }
                });
            }
            
            if (update.updateType === 'session_edit' && !update.isDeleted) {
                Object.keys(storage).forEach(date => {
                    storage[date].completed = storage[date].completed.map(session => {
                        const matches = 
                            (update.sessionId && session.id === update.sessionId) ||
                            (session.deviceLabel === update.originalDeviceLabel &&
                             session.startISO === update.originalStartISO);
                        
                        if (matches) {
                            hasChanges = true;
                            return {
                                ...session,
                                deviceLabel: update.deviceLabel || session.deviceLabel,
                                price: update.price !== undefined ? roundToNearestFive(update.price) : session.price,
                                drinks: update.drinks || session.drinks,
                                mode: update.mode || session.mode,
                                duration: update.duration || session.duration,
                                updatedByAdmin: true,
                                lastUpdate: new Date().toISOString()
                            };
                        }
                        return session;
                    });
                });
            }
        }
    });
    
    if (hasChanges) {
        setStorage(storage);
        initLocal();
        renderDevices();
        showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
    }
    hideSyncIndicator();
});
// ========== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase ==========

  // events delegation for device buttons
  devicesGrid.addEventListener('click', (e)=>{ 
      const btn = e.target.closest('button'); 
      if(!btn) return; 
      const action = btn.dataset.action; 
      const idx = Number(btn.dataset.idx); 
      if(action === 'start') openStartModal(idx); 
      if(action === 'add') openAddDrinkModal(idx); 
      if(action === 'end') openEndModal(idx); 
  });

  // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
          tabButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTab = btn.dataset.tab;
          renderCompleted();
      });
  });

  // expense modal events
  addExpenseBtn.addEventListener('click', () => {
    expenseName.value = '';
    expenseAmount.value = '1';
    modalExpense.classList.add('active');
  });

  confirmAddExpense.addEventListener('click', () => {
    const name = expenseName.value.trim();
    const amount = Number(expenseAmount.value);
    
    if (!name) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ');
      return;
    }
    
    if (!amount || amount <= 0) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
      return;
    }
    
    expensesToday.push({
      name,
      amount,
      date: new Date().toISOString()
    });
    
    persistLocal();
    renderExpenses();
    modalExpense.classList.remove('active');
  });

  cancelAddExpense.addEventListener('click', () => {
    modalExpense.classList.remove('active');
  });

  // Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('danger') && e.target.dataset.expenseIndex) {
      const index = Number(e.target.dataset.expenseIndex);
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) {
        expensesToday.splice(index, 1);
        persistLocal();
        renderExpenses();
      }
    }
  });

  // start modal
  let selectedIdx = null;
  function openStartModal(idx){ 
      selectedIdx = idx; 
      const dev = DEVICES[idx]; 
      startDevice.value = dev.label; 
      sessionKind.value = 'open'; 
      sessionEndTime.value = ''; 
      playMode.value = 'single'; 
      endTimeRow.style.display = 'none'; 
      modalStart.classList.add('active'); 
  }
  
  sessionKind.addEventListener('change', ()=> { 
      endTimeRow.style.display = sessionKind.value === 'set' ? 'block' : 'none'; 
  });
  
  confirmStart.addEventListener('click', async ()=>{ 
      const dev = DEVICES[selectedIdx]; 
      const id = dev.id; 
      const kind = sessionKind.value; 
      let scheduledEndISO = null; 
      if(kind === 'set'){ 
          if(!sessionEndTime.value){ 
              alert('Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'); 
              return; 
          } 
          scheduledEndISO = isoFromTimeStr(sessionEndTime.value); 
      } 
      const mode = playMode.value; 
      const startISO = nowISO(); 
      
      const newSession = { 
          deviceId: id, 
          deviceLabel: dev.label, 
          startISO, 
          scheduledEndISO, 
          mode, 
          drinks: [], 
          rateType: dev.type 
      };
      
      openSessions[id] = newSession;
      persistLocal(); 
      await saveOpenSessionToFirebase(newSession);
      renderDevices(); 
      modalStart.classList.remove('active'); 
  });
  
  cancelStart.addEventListener('click', ()=> modalStart.classList.remove('active'));

  // add drink modal
  function openAddDrinkModal(idx){ 
      selectedIdx = idx; 
      const dev = DEVICES[idx]; 
      drinkDevice.value = dev.label; 
      drinkSelect.value = ''; 
      drinkQty.value = 1; 
      modalDrink.classList.add('active'); 
  }
  
  confirmAddDrink.addEventListener('click', async ()=>{ 
      const sel = drinkSelect.value; 
      const qty = Number(drinkQty.value) || 1; 
      if(!sel) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø·Ù„Ø¨'); 
      const dev = DEVICES[selectedIdx]; 
      const id = dev.id; 
      const s = openSessions[id]; 
      if(!s) return alert('Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù‚ÙÙˆÙ„Ø©'); 
      
      let name, price; 
      if(sel === 'Ù…ØªÙ†ÙˆØ¹'){ 
          name = prompt('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±') || 'Ù…ØªÙ†ÙˆØ¹'; 
          price = Number(prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡)') || 0); 
      } else { 
          [name, price] = sel.split('|'); 
          price = Number(price); 
      } 
      
      if(!Array.isArray(s.drinks)) s.drinks = []; 
      s.drinks.push({ name, price, qty }); 
      openSessions[id] = s; 
      persistLocal(); 
      await saveOpenSessionToFirebase(s); 
      renderDevices(); 
      modalDrink.classList.remove('active'); 
  });
  
  cancelAddDrink.addEventListener('click', ()=> modalDrink.classList.remove('active'));

  // end modal
  function openEndModal(idx){ 
      selectedIdx = idx; 
      const dev = DEVICES[idx]; 
      const id = dev.id; 
      const s = openSessions[id]; 
      if(!s) return alert('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); 
      endDeviceLabel.textContent = s.deviceLabel; 
      endFrom.value = format12FromISO(s.startISO); 
      const endISO = s.scheduledEndISO || nowISO(); 
      endTo.value = format12FromISO(endISO); 
      const mins = diffMinutes(s.startISO, s.scheduledEndISO || nowISO()); 
      endDuration.value = durationText(mins); 
      endDrinks.value = (s.drinks && s.drinks.length) ? s.drinks.map(d=>`${d.name}Ã—${d.qty}`).join(', ') : '-'; 
      const drinksTotal = (s.drinks||[]).reduce((a,b)=>a+(b.price*b.qty),0); 
      const rate = RATES[s.rateType][s.mode]; 
      const price = Number((((mins/60)*rate) + drinksTotal).toFixed(2)); 
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      const roundedPrice = roundToNearestFive(price);
      endTotal.value = roundedPrice; 
      modalEnd.classList.add('active'); 
  }
  confirmEnd.addEventListener('click', async ()=>{ 
  const idx = selectedIdx; 
  const dev = DEVICES[idx]; 
  const id = dev.id; 
  const s = openSessions[id]; 
  if(!s) return alert('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); 
  
  const endISO = s.scheduledEndISO || nowISO(); 
  const mins = diffMinutes(s.startISO, endISO); 
  const drinksTotal = (s.drinks||[]).reduce((a,b)=>a+(b.price*b.qty),0); 
  const rate = RATES[s.rateType][s.mode]; 
  const price = Number((((mins/60)*rate) + drinksTotal).toFixed(2)); 
  
  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
  const roundedPrice = roundToNearestFive(price);
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù„Ø³Ø©
  const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  
  const finished = { 
      deviceId: s.deviceId, 
      deviceLabel: s.deviceLabel, 
      startISO: s.startISO, 
      endISO, 
      duration: durationText(mins), 
      drinks: s.drinks || [], 
      price: roundedPrice,
      sessionId: sessionId,
      mode: s.mode,
      rateType: s.rateType,
      createdAt: new Date().toISOString(),
      createdBy: auth.currentUser ? auth.currentUser.email : 'unknown',
      date: todayKey() // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
  }; 
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  const isDuplicate = completedSessionsToday.some(existingSession => 
      existingSession.deviceLabel === finished.deviceLabel &&
      existingSession.startISO === finished.startISO &&
      existingSession.endISO === finished.endISO &&
      existingSession.price === finished.price
  );
  
  if (isDuplicate) {
      alert('âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹');
      return;
  }
  
  completedSessionsToday.push(finished); 
  delete openSessions[id]; 
  persistLocal(); 
  await removeOpenSessionFromFirebase(id);
  renderDevices(); 
  modalEnd.classList.remove('active'); 
  
  try {
      // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Firebase
      await addDoc(collection(db, "sessions"), finished);
      console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­");
      alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + roundedPrice + ' Ø¬'); 
  } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©:", error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Firebase: ' + error.message);
  }
});
//   confirmEnd.addEventListener('click', async ()=>{ 
//   const idx = selectedIdx; 
//   const dev = DEVICES[idx]; 
//   const id = dev.id; 
//   const s = openSessions[id]; 
//   if(!s) return alert('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); 
  
//   const endISO = s.scheduledEndISO || nowISO(); 
//   const mins = diffMinutes(s.startISO, endISO); 
//   const drinksTotal = (s.drinks||[]).reduce((a,b)=>a+(b.price*b.qty),0); 
//   const rate = RATES[s.rateType][s.mode]; 
//   const price = Number((((mins/60)*rate) + drinksTotal).toFixed(2)); 
  
//   // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
//   const roundedPrice = roundToNearestFive(price);
  
//   const finished = { 
//       deviceId: s.deviceId, 
//       deviceLabel: s.deviceLabel, 
//       startISO: s.startISO, 
//       endISO, 
//       duration: durationText(mins), 
//       drinks: s.drinks || [], 
//       price: roundedPrice,
//       // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
//       sessionId: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
//   }; 
  
//   // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù…ÙƒØ±Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
//   const isDuplicate = completedSessionsToday.some(existingSession => 
//       existingSession.deviceLabel === finished.deviceLabel &&
//       existingSession.startISO === finished.startISO &&
//       existingSession.endISO === finished.endISO
//   );
  
//   if (isDuplicate) {
//       alert('âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹');
//       return;
//   }
  
//   completedSessionsToday.push(finished); 
//   delete openSessions[id]; 
//   persistLocal(); 
//   await removeOpenSessionFromFirebase(id);
//   renderDevices(); 
//   modalEnd.classList.remove('active'); 
  
//   try {
//       const user = auth.currentUser;
//       const now = new Date();

//       const payload = {
//           deviceId: s.deviceId,
//           deviceLabel: s.deviceLabel,
//           mode: s.mode,
//           startISO: s.startISO,
//           endISO: endISO,
//           duration: durationText(mins),
//           price: roundedPrice,
//           drinks: s.drinks || [],
//           createdBy: user ? user.email : "local",
//           createdAt: now.toISOString(),
//           date: now.toLocaleDateString("ar-EG"),
//           // Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
//           sessionId: finished.sessionId
//       };

//       await addDoc(collection(db, "sessions"), payload);
//       console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­");
//       alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ' + roundedPrice + ' Ø¬'); 
//   } catch (error) {
//       console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©:", error);
//       alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Firebase');
//   }
// });
  cancelEnd.addEventListener('click', ()=> modalEnd.classList.remove('active'));

  // event listeners Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  clearDataBtn.addEventListener('click', () => {
      modalClearData.classList.add('active');
  });

  confirmClearData.addEventListener('click', async () => {
      await clearAllDataPermanently();
  });

  cancelClearData.addEventListener('click', () => {
      modalClearData.classList.remove('active');
  });

  // Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
  syncBtn.addEventListener('click', async () => {
      showSyncIndicator();
      initLocal();
      renderDevices();
      setTimeout(() => {
          hideSyncIndicator();
          showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
      }, 1500);
  });

  // close modals on backdrop click
  document.querySelectorAll('.modal-back').forEach(mb=> mb.addEventListener('click', ev=> { if(ev.target===mb) mb.classList.remove('active'); }));

  // logout
  logoutBtn.addEventListener('click', async ()=> { 
      try{ 
          await signOut(auth); 
          alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); 
          window.location.href='login.html'; 
      }catch(e){ 
          alert('Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); 
      } 
  });

  // admin button - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
  goAdminBtn.addEventListener('click', ()=> { 
      const user = auth.currentUser; 
      if (user) {
          const adminEmails = ["moosama@gmail.com", "ahmed@gmail.com", "mahmoud@gmail.com"];
          if (adminEmails.includes(user.email)) {
              window.location.href = 'welcome.html';
          } else {
              alert('âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø´Ø±Ù\nÙŠÙ…ÙƒÙ†Ùƒ ÙÙ‚Ø· Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
          }
      } else {
          window.location.href = 'login.html';
      }
  });

  // auth display and protection
  onAuthStateChanged(auth, user => { 
      if(user) {
          userEmailSpan.textContent = user.email; 
          
          // ğŸ”§ Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
          const adminEmails = ["moosama@gmail.com", "ahmed@gmail.com", "mahmoud@gmail.com"];
          if (window.location.pathname.includes('welcome.html') || window.location.pathname.includes('admin.html')) {
              if (!adminEmails.includes(user.email)) {
                  window.location.href = 'index.html';
              }
          }
      } else {
          userEmailSpan.textContent='';
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ ÙŠÙˆØ¬Ù‡ Ù„ØµÙØ­Ø© Login
          if (!window.location.pathname.includes('login.html')) {
              window.location.href = 'login.html';
          }
      } 
  });

  // init
  (function init(){ 
      todayStr.textContent = new Date().toLocaleDateString('ar-EG'); 
      
      // ØªØ­Ù…ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³Ø­ Ù…Ù† localStorage
      dataClearDate = localStorage.getItem('dataClearDate') || '';
      console.log('ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø´Ø·:', dataClearDate);
      
      initLocal(); 
      renderDevices(); 
      
      console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
      
      window.__bianco = { openSessions, completedSessionsToday, allSessions, expensesToday, persistLocal, renderDevices }; 
  })();
</script>
</body>
</html>
